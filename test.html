<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firmador de Documentos APC - Lulo Panamá</title>
    <meta name="robots" content="nofollow">
    <style>
        :root {
            --lulo-panama-primary: #004951;
            --lulo-panama-secondary: #f3f3f3;
            --text-color: #333;
            --border-color: #ccc;
            --hover-bg-color: #e9f3f4;
            --canvas-bg-color: #fff; /* White background for handwriting canvases */
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px; 
            background-color: var(--lulo-panama-secondary);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: white;
            padding: 15px; 
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        h1 {
            color: var(--lulo-panama-primary);
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em; 
        }

        .main-layout-grid { /* New grid for overall layout */
            display: grid;
            grid-template-columns: 1fr; /* Default single column */
            gap: 20px;
        }

        .document-display-area { /* Area for main document canvas and export */
            grid-column: 1 / -1; /* Span full width if multiple columns */
        }
        
        .input-areas-grid { /* Grid for selection, name, cedula, signature pads */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px;
        }


        .control-group {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: #fdfdfd;
        }

        .control-group h3 {
            margin-top: 0;
            color: var(--lulo-panama-primary);
            border-bottom: 1px solid var(--lulo-panama-primary);
            padding-bottom: 5px;
            font-size: 1.1em; 
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="number"],
        select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: var(--lulo-panama-primary);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        button:hover {
            background-color: #003338;
        }

        .handwriting-pad-area, .signature-pad-area {
            margin: 0 auto 10px auto; 
            max-width: 380px; 
        }
        
        .handwriting-canvas, #signatureCanvas { /* Common style for all drawing canvases */
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: crosshair;
            width: 100%; 
            height: auto; /* Aspect ratio maintained by JS/attributes */
            display: block; 
            background-color: var(--canvas-bg-color);
        }


        .canvas-container {
            width: 100%;
            margin-bottom: 20px;
            position: relative; 
            max-height: 80vh; 
            overflow: auto; 
            border: 1px solid var(--border-color); 
        }

        #mainDocumentCanvas {
            border-radius: 4px;
            display: block; 
            margin: 0 auto; 
            background-color: #f0f0f0; /* Slightly different from body for visual separation */
            touch-action: none; 
            /* CSS width/height will be set by JS to match logical pixels after DPR scaling */
        }
        
        .selected-element-controls {
            padding: 10px;
            border: 1px dashed var(--lulo-panama-primary);
            margin-top: 10px;
            border-radius: 4px;
        }
        .selected-element-controls label {
             margin-top: 8px;
        }

        @media (min-width: 992px) { /* Larger screens: two columns for inputs, one for document */
            .main-layout-grid {
                grid-template-columns: 400px 1fr; /* Fixed width for controls, rest for document */
            }
            .input-areas-grid {
                grid-template-columns: 1fr; /* Inputs stack in the first column */
            }
            .document-display-area {
                grid-column: 2 / 3; /* Document takes the second column */
            }
        }


        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 10px;}
            h1 { font-size: 1.5em; }
            .control-group h3 { font-size: 1em; }
        }
         @media (max-width: 480px) {
            h1 { font-size: 1.3em; }
            button { padding: 8px 12px; font-size: 0.9em;}
            input[type="number"], select { padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Firmador de Documentos APC</h1>

        <div class="main-layout-grid">
            <div class="input-areas-container">
                <div class="input-areas-grid">
                    <div class="control-group">
                        <h3>1. Seleccione Documento</h3>
                        <label for="documentSelector">Plantilla APC:</label>
                        <select id="documentSelector"></select>
                    </div>

                    <div class="control-group">
                        <h3>2. Nombre (Manuscrito)</h3>
                        <div class="handwriting-pad-area">
                            <canvas class="handwriting-canvas" id="nameCanvas" data-logical-width="300" data-logical-height="100"></canvas>
                        </div>
                        <button id="clearNameBtn">Limpiar Nombre</button>
                        <button id="confirmNameBtn">Confirmar Nombre</button>
                    </div>

                    <div class="control-group">
                        <h3>3. Cédula (Manuscrita)</h3>
                        <div class="handwriting-pad-area">
                            <canvas class="handwriting-canvas" id="cedulaCanvas" data-logical-width="300" data-logical-height="100"></canvas>
                        </div>
                        <button id="clearCedulaBtn">Limpiar Cédula</button>
                        <button id="confirmCedulaBtn">Confirmar Cédula</button>
                    </div>
                    
                    <div class="control-group">
                        <h3>4. Firme y Escriba la Fecha Aquí</h3>
                        <div class="signature-pad-area">
                            <canvas id="signatureCanvas" data-logical-width="360" data-logical-height="150"></canvas>
                        </div>
                        <button id="clearSignatureBtn">Limpiar Firma y Fecha</button>
                        <button id="confirmSignatureBtn">Confirmar Firma y Fecha</button>
                    </div>

                     <div class="control-group" id="elementSizingControls" style="display:none;">
                        <h3>5. Ajustar Elemento Seleccionado</h3>
                        <p>Haga clic en un elemento sobre el documento para seleccionarlo y ajustar su tamaño aquí.</p>
                        <div id="imageElementControls"> <label for="elementWidth">Ancho del Elemento (px):</label>
                            <input type="number" id="elementWidth" min="20" max="800">
                            <label for="elementHeight">Alto del Elemento (px):</label>
                            <input type="number" id="elementHeight" min="20" max="800">
                        </div>
                    </div>
                </div>
            </div>

            <div class="document-display-area">
                 <div class="control-group">
                    <h3>Visualice y Ajuste el Documento</h3>
                    <p>Haga clic y arrastre los elementos sobre el documento para cambiar su posición. Use los controles de la sección 5 para cambiar tamaños.</p>
                </div>
                <div class="canvas-container">
                    <canvas id="mainDocumentCanvas"></canvas>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="exportDocumentBtn">Exportar Documento Actual (JPG)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const dpr = window.devicePixelRatio || 1;

        const documentConfigurations = [
            { path: "apc/apc-multi-actual.jpg", shortName: "multi", displayName: "Multi" },
            { path: "apc/apc-bac-actual.jpg", shortName: "bac", displayName: "BAC" },
            { path: "apc/apc-global-actual.jpg", shortName: "global", displayName: "Global" }
        ];

        const appState = {
            currentDocumentUrl: null,
            // sharedInputs now store image caches directly
            nameImageCache: null,
            cedulaImageCache: null,
            signatureImageCache: null, 
            documentSettings: {}, 
            activeElementId: null, 
            dragState: {
                isDragging: false,
                elementId: null,
                offsetX: 0,
                offsetY: 0
            },
            backgroundImage: null, 
        };

        // --- DOM Element References ---
        const documentSelector = document.getElementById('documentSelector');
        
        // Name Pad
        const nameCanvas = document.getElementById('nameCanvas');
        const clearNameBtn = document.getElementById('clearNameBtn');
        const confirmNameBtn = document.getElementById('confirmNameBtn');
        let nameCtx; // To be initialized

        // Cedula Pad
        const cedulaCanvas = document.getElementById('cedulaCanvas');
        const clearCedulaBtn = document.getElementById('clearCedulaBtn');
        const confirmCedulaBtn = document.getElementById('confirmCedulaBtn');
        let cedulaCtx; // To be initialized

        // Signature Pad
        const signaturePad = document.getElementById('signatureCanvas');
        const clearSignatureBtn = document.getElementById('clearSignatureBtn');
        const confirmSignatureBtn = document.getElementById('confirmSignatureBtn');
        let sigCtx; // To be initialized
        
        // Main Document Canvas
        const mainCanvas = document.getElementById('mainDocumentCanvas');
        const mainCtx = mainCanvas.getContext('2d'); // Initial context, will be re-scaled

        // Export and Sizing Controls
        const exportDocumentBtn = document.getElementById('exportDocumentBtn');
        const elementSizingControls = document.getElementById('elementSizingControls');
        const imageElementControls = document.getElementById('imageElementControls'); // Only image controls now
        const elementWidthInput = document.getElementById('elementWidth');
        const elementHeightInput = document.getElementById('elementHeight');

        // --- Drawing Pad State Variables ---
        // (Could be encapsulated if many more pads were added)
        let drawingStates = {
            name: {isDrawing: false, lastX:0, lastY:0},
            cedula: {isDrawing: false, lastX:0, lastY:0},
            signature: {isDrawing: false, lastX:0, lastY:0}
        };

        // --- Canvas Setup and DPR Scaling ---
        function setupDrawingCanvas(canvasEl, logicalWidth, logicalHeight, stateKey) {
            const ctx = canvasEl.getContext('2d');
            
            canvasEl.style.width = logicalWidth + 'px';
            canvasEl.style.height = logicalHeight + 'px';

            canvasEl.width = logicalWidth * dpr;
            canvasEl.height = logicalHeight * dpr;
            
            ctx.scale(dpr, dpr);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2; 
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Clear canvas initially
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--canvas-bg-color').trim() || '#ffffff';
            ctx.fillRect(0, 0, logicalWidth, logicalHeight); // Fill with logical dimensions

            // Event listeners for this canvas
            canvasEl.addEventListener('mousedown', (e) => startDrawing(e, ctx, stateKey));
            canvasEl.addEventListener('mousemove', (e) => draw(e, ctx, stateKey));
            canvasEl.addEventListener('mouseup', () => stopDrawing(stateKey));
            canvasEl.addEventListener('mouseleave', () => stopDrawing(stateKey));
            canvasEl.addEventListener('touchstart', (e) => startDrawing(e, ctx, stateKey), { passive: false });
            canvasEl.addEventListener('touchmove', (e) => draw(e, ctx, stateKey), { passive: false });
            canvasEl.addEventListener('touchend', () => stopDrawing(stateKey));
            
            return ctx;
        }
        
        function initializeDrawingPads() {
            nameCtx = setupDrawingCanvas(nameCanvas, parseInt(nameCanvas.dataset.logicalWidth), parseInt(nameCanvas.dataset.logicalHeight), 'name');
            cedulaCtx = setupDrawingCanvas(cedulaCanvas, parseInt(cedulaCanvas.dataset.logicalWidth), parseInt(cedulaCanvas.dataset.logicalHeight), 'cedula');
            sigCtx = setupDrawingCanvas(signaturePad, parseInt(signaturePad.dataset.logicalWidth), parseInt(signaturePad.dataset.logicalHeight), 'signature');
        }


        // --- Drawing Logic for Handwriting Pads (Generic) ---
        function getPadCoordinates(canvasEl, event) {
            const rect = canvasEl.getBoundingClientRect();
            let clientX, clientY;
            if (event.touches && event.touches.length > 0) {
                clientX = event.touches[0].clientX;
                clientY = event.touches[0].clientY;
            } else if (event.clientX !== undefined) {
                clientX = event.clientX;
                clientY = event.clientY;
            } else {
                return null;
            }
            // Return coordinates scaled to logical canvas size
            return { 
                x: (clientX - rect.left) / (rect.width / parseInt(canvasEl.dataset.logicalWidth || canvasEl.width/dpr)), // scale back to logical
                y: (clientY - rect.top) / (rect.height / parseInt(canvasEl.dataset.logicalHeight || canvasEl.height/dpr))
            };
        }

        function startDrawing(e, ctx, stateKey) {
            const padState = drawingStates[stateKey];
            padState.isDrawing = true;
            const coords = getPadCoordinates(ctx.canvas, e);
            if (!coords) return;

            ctx.beginPath(); 
            ctx.moveTo(coords.x, coords.y);
            padState.lastX = coords.x; 
            padState.lastY = coords.y;
            if(e.cancelable) e.preventDefault();
        }

        function draw(e, ctx, stateKey) {
            const padState = drawingStates[stateKey];
            if (!padState.isDrawing) return;
            const coords = getPadCoordinates(ctx.canvas, e);
            if (!coords) return;

            ctx.lineTo(coords.x, coords.y);
            ctx.stroke(); 
            
            padState.lastX = coords.x;
            padState.lastY = coords.y;
            if(e.cancelable) e.preventDefault();
        }
        
        function stopDrawing(stateKey) {
            if (drawingStates[stateKey].isDrawing) {
                drawingStates[stateKey].isDrawing = false;
            }
        }

        function clearDrawingPad(ctx, stateKey, imageCacheKey) {
            const logicalWidth = parseInt(ctx.canvas.dataset.logicalWidth || ctx.canvas.width/dpr);
            const logicalHeight = parseInt(ctx.canvas.dataset.logicalHeight || ctx.canvas.height/dpr);
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--canvas-bg-color').trim() || '#ffffff';
            ctx.fillRect(0, 0, logicalWidth, logicalHeight);
            appState[imageCacheKey] = null; 
            redrawMainCanvas();
        }

        function confirmDrawingPad(ctx, imageCacheKey) {
            const tempImage = new Image();
            tempImage.onload = () => {
                appState[imageCacheKey] = tempImage;
                redrawMainCanvas();
            }
            tempImage.src = ctx.canvas.toDataURL('image/png');
        }

        // --- Main Application Logic ---
        function initializeDefaultDocumentSettings() {
            const defaultElementWidth = 150; 
            const defaultElementHeight = 50; 
            const defaultSigWidth = 180; 
            const defaultSigHeight = 90;
            
            documentConfigurations.forEach(docConfig => {
                const docPath = docConfig.path;
                if (!appState.documentSettings[docPath]) {
                    appState.documentSettings[docPath] = {
                        elements: [ // All elements are now images
                            { id: 'name', type: 'image', x: 50, y: 50, width: defaultElementWidth, height: defaultElementHeight },
                            { id: 'cedula', type: 'image', x: 50, y: 110, width: defaultElementWidth, height: defaultElementHeight },
                            { id: 'signature', type: 'image', x: 50, y: 170, width: defaultSigWidth, height: defaultSigHeight }
                        ]
                    };
                }
            });
        }
        
        function populateDocumentSelector() {
            documentConfigurations.forEach(docConfig => {
                const option = document.createElement('option');
                option.value = docConfig.path;
                option.textContent = docConfig.displayName; 
                documentSelector.appendChild(option);
            });
        }

        function handleUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            let selectedDocPath = null;
            const eParamValue = params.get('e');
            if (eParamValue) {
                const foundDoc = documentConfigurations.find(doc => doc.shortName.toLowerCase() === eParamValue.toLowerCase());
                if (foundDoc) selectedDocPath = foundDoc.path;
            }
            if (!selectedDocPath) {
                for (const docConfig of documentConfigurations) {
                    if (params.has(docConfig.shortName.toLowerCase())) {
                        selectedDocPath = docConfig.path;
                        break; 
                    }
                }
            }
            if (selectedDocPath) documentSelector.value = selectedDocPath;
        }

        function loadDocument(docUrl) {
            appState.currentDocumentUrl = docUrl;
            appState.backgroundImage = new Image();
            appState.backgroundImage.onload = () => {
                const canvasContainer = mainCanvas.parentElement;
                let displayWidth = canvasContainer.clientWidth;
                let displayHeight = (displayWidth / appState.backgroundImage.naturalWidth) * appState.backgroundImage.naturalHeight;

                const containerStyle = getComputedStyle(canvasContainer);
                const containerMaxHeight = parseFloat(containerStyle.maxHeight);

                if (!isNaN(containerMaxHeight) && displayHeight > containerMaxHeight) {
                    displayHeight = containerMaxHeight;
                    displayWidth = (displayHeight / appState.backgroundImage.naturalHeight) * appState.backgroundImage.naturalWidth;
                }
                displayWidth = Math.min(displayWidth, canvasContainer.clientWidth); // Ensure it doesn't exceed container width

                mainCanvas.style.width = displayWidth + 'px';
                mainCanvas.style.height = displayHeight + 'px';
                mainCanvas.width = displayWidth * dpr;
                mainCanvas.height = displayHeight * dpr;
                
                mainCtx.resetTransform(); // Clear previous transforms if any
                mainCtx.scale(dpr, dpr);
                // Set image smoothing for better quality if browser supports it well for downscaling
                mainCtx.imageSmoothingEnabled = true;
                mainCtx.imageSmoothingQuality = "high";


                redrawMainCanvas();
                updateSelectedElementControls(); 
            };
            appState.backgroundImage.onerror = () => {
                console.error("Error cargando imagen del documento:", docUrl);
                mainCtx.resetTransform(); mainCtx.scale(dpr, dpr); // Reset before drawing error
                mainCtx.clearRect(0, 0, mainCanvas.width/dpr, mainCanvas.height/dpr); // Clear logical area
                mainCtx.fillStyle = "red"; mainCtx.font = "16px Arial"; mainCtx.textAlign = "center";
                const currentDocConfig = documentConfigurations.find(dc => dc.path === docUrl);
                const docName = currentDocConfig ? currentDocConfig.displayName : docUrl.split('/').pop();
                mainCtx.fillText("Error al cargar: " + docName, mainCanvas.width/(2*dpr), mainCanvas.height/(2*dpr));
            }
            appState.backgroundImage.src = docUrl;
        }
        
        function getElementById(docUrl, elementId) {
            if (appState.documentSettings[docUrl]) {
                return appState.documentSettings[docUrl].elements.find(el => el.id === elementId);
            }
            return null;
        }

        function redrawMainCanvas(isExporting = false) {
            if (!appState.currentDocumentUrl || !appState.backgroundImage || !appState.backgroundImage.complete) {
                const logicalWidth = mainCanvas.width / dpr;
                const logicalHeight = mainCanvas.height / dpr;
                if (logicalWidth > 0 && logicalHeight > 0) {
                    mainCtx.resetTransform(); mainCtx.scale(dpr, dpr);
                    mainCtx.clearRect(0, 0, logicalWidth, logicalHeight);
                    mainCtx.fillStyle = "gray"; mainCtx.font = "16px Arial"; mainCtx.textAlign = "center";
                    mainCtx.fillText("Cargando...", logicalWidth / 2, logicalHeight / 2);
                }
                return;
            }
            
            const logicalWidth = mainCanvas.width / dpr;
            const logicalHeight = mainCanvas.height / dpr;

            mainCtx.clearRect(0, 0, logicalWidth, logicalHeight); // Clear logical area
            mainCtx.drawImage(appState.backgroundImage, 0, 0, logicalWidth, logicalHeight);

            const currentDocSettings = appState.documentSettings[appState.currentDocumentUrl];
            if (!currentDocSettings) return;

            currentDocSettings.elements.forEach(element => {
                // All elements are 'image' type now
                const imageToDraw = appState[element.id + 'ImageCache']; // e.g., appState.nameImageCache
                if (imageToDraw) {
                    mainCtx.drawImage(imageToDraw, element.x, element.y, element.width, element.height);
                    if (appState.activeElementId === element.id && !isExporting) {
                        mainCtx.strokeStyle = 'var(--lulo-panama-primary)'; 
                        mainCtx.lineWidth = 1.5 / dpr; // Adjust line width for scaled context
                        mainCtx.strokeRect(element.x - 1, element.y - 1, element.width + 2, element.height + 2); 
                    }
                }
            });
        }

        function getCanvasCoordinates(event) { // For mainDocumentCanvas
            const rect = mainCanvas.getBoundingClientRect(); //Gives display dimensions
            let clientX, clientY;
            if (event.touches && event.touches.length > 0) {
                clientX = event.touches[0].clientX; clientY = event.touches[0].clientY;
            } else if (event.clientX !== undefined) {
                clientX = event.clientX; clientY = event.clientY;
            } else { return null; }
            // Coordinates relative to displayed canvas, these are logical pixels
            return { 
                x: (clientX - rect.left),
                y: (clientY - rect.top)
            };
        }
        
        function isPointInElement(pointX, pointY, element) { // pointX, pointY are logical
            // All elements are images, use their x,y,width,height (all logical)
            return pointX >= element.x && pointX <= element.x + element.width && 
                   pointY >= element.y && pointY <= element.y + element.height;
        }

        function handleCanvasMouseDown(event) {
            const coords = getCanvasCoordinates(event);
            if (!coords) return;
            const { x, y } = coords; // These are logical coordinates

            const currentDocSettings = appState.documentSettings[appState.currentDocumentUrl];
            if (!currentDocSettings) return;

            let selected = null;
            for (let i = currentDocSettings.elements.length - 1; i >= 0; i--) {
                const element = currentDocSettings.elements[i];
                if (isPointInElement(x, y, element)) {
                    selected = element;
                    break;
                }
            }
            
            appState.activeElementId = selected ? selected.id : null;
            if (selected) {
                appState.dragState = {
                    isDragging: true, elementId: selected.id,
                    offsetX: x - selected.x, offsetY: y - selected.y
                };
            } else {
                appState.dragState.isDragging = false;
            }
            updateSelectedElementControls();
            redrawMainCanvas();
            if (event.cancelable) event.preventDefault();
        }

        function handleCanvasMouseMove(event) {
            if (!appState.dragState.isDragging || !appState.dragState.elementId) return;
            const coords = getCanvasCoordinates(event);
            if (!coords) return;
            const { x, y } = coords; // Logical coordinates
            
            const element = getElementById(appState.currentDocumentUrl, appState.dragState.elementId);
            if (element) {
                element.x = x - appState.dragState.offsetX;
                element.y = y - appState.dragState.offsetY;
                redrawMainCanvas();
            }
            if (event.cancelable) event.preventDefault();
        }

        function handleCanvasInteractionEnd() { 
            if (appState.dragState.isDragging) { 
                appState.dragState.isDragging = false;
            }
        }
        
        function updateSelectedElementControls() {
            const activeElement = appState.activeElementId ? getElementById(appState.currentDocumentUrl, appState.activeElementId) : null;
            if (activeElement) { // All elements are images now
                elementSizingControls.style.display = 'block';
                imageElementControls.style.display = 'block'; // Only image controls visible
                elementWidthInput.value = activeElement.width;
                elementHeightInput.value = activeElement.height;
            } else {
                elementSizingControls.style.display = 'none';
            }
        }

        function handleSizeInputChange() { // Now only for images (all elements)
            const activeElement = appState.activeElementId ? getElementById(appState.currentDocumentUrl, appState.activeElementId) : null;
            if (!activeElement) return;
            activeElement.width = parseInt(elementWidthInput.value, 10) || 100; // Default if parse fails
            activeElement.height = parseInt(elementHeightInput.value, 10) || 50;
            redrawMainCanvas();
        }
        
        // --- Event Listeners Setup ---
        function setupEventListeners() {
            documentSelector.addEventListener('change', (e) => {
                appState.activeElementId = null; 
                updateSelectedElementControls();
                loadDocument(e.target.value);
            });

            // Name Pad Listeners
            clearNameBtn.addEventListener('click', () => clearDrawingPad(nameCtx, 'name', 'nameImageCache'));
            confirmNameBtn.addEventListener('click', () => confirmDrawingPad(nameCtx, 'nameImageCache'));

            // Cedula Pad Listeners
            clearCedulaBtn.addEventListener('click', () => clearDrawingPad(cedulaCtx, 'cedula', 'cedulaImageCache'));
            confirmCedulaBtn.addEventListener('click', () => confirmDrawingPad(cedulaCtx, 'cedulaImageCache'));
            
            // Signature Pad Listeners
            clearSignatureBtn.addEventListener('click', () => clearDrawingPad(sigCtx, 'signature', 'signatureImageCache'));
            confirmSignatureBtn.addEventListener('click', () => confirmDrawingPad(sigCtx, 'signatureImageCache'));

            // Main Canvas Interaction
            mainCanvas.addEventListener('mousedown', handleCanvasMouseDown);
            mainCanvas.addEventListener('mousemove', handleCanvasMouseMove);
            mainCanvas.addEventListener('mouseup', handleCanvasInteractionEnd);
            mainCanvas.addEventListener('mouseleave', handleCanvasInteractionEnd); 
            mainCanvas.addEventListener('touchstart', handleCanvasMouseDown, { passive: false });
            mainCanvas.addEventListener('touchmove', handleCanvasMouseMove, { passive: false });
            mainCanvas.addEventListener('touchend', handleCanvasInteractionEnd);

            // Sizing Controls
            elementWidthInput.addEventListener('change', handleSizeInputChange);
            elementHeightInput.addEventListener('change', handleSizeInputChange);

            exportDocumentBtn.addEventListener('click', () => {
                if (!appState.currentDocumentUrl || !appState.backgroundImage || !appState.backgroundImage.complete) {
                    alert("Por favor, seleccione y cargue un documento primero."); return;
                }
                const lastActiveElement = appState.activeElementId;
                appState.activeElementId = null; // No selection box for export
                
                // Create a temporary canvas for export if DPR scaling is complex or to ensure original size
                // For now, export directly from mainCanvas, which is already DPR scaled.
                // The toDataURL will capture the full resolution buffer.
                redrawMainCanvas(true); // isExporting = true

                const dataUrl = mainCanvas.toDataURL('image/jpeg', 0.92); // Quality 0.92
                const link = document.createElement('a');
                link.href = dataUrl;
                const currentDocConfig = documentConfigurations.find(dc => dc.path === appState.currentDocumentUrl);
                const shortNameForFile = currentDocConfig ? currentDocConfig.shortName : 'documento';
                const dateForFile = new Date().toISOString().slice(0,10).replace(/-/g,'');
                link.download = `APC_Firmado_${shortNameForFile}_${dateForFile}.jpg`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);

                appState.activeElementId = lastActiveElement; // Restore selection
                if(lastActiveElement) redrawMainCanvas(); 
            });

            window.addEventListener('resize', () => {
                initializeDrawingPads(); // Re-setup aux canvases as their client size might change
                if (appState.currentDocumentUrl && appState.backgroundImage && appState.backgroundImage.complete) {
                    loadDocument(appState.currentDocumentUrl); 
                }
            });
        }

        // --- Initialization ---
        initializeDefaultDocumentSettings();
        populateDocumentSelector();
        initializeDrawingPads(); // Setup name, cedula, signature pads
        handleUrlParameters(); 
        setupEventListeners();
        
        if (documentSelector.value) { 
            loadDocument(documentSelector.value);
        } else if (documentConfigurations.length > 0) { 
            documentSelector.value = documentConfigurations[0].path;
            loadDocument(documentConfigurations[0].path);
        } else {
            console.error("No hay documentos APC configurados.");
             if(mainCanvas.width > 0 && mainCanvas.height > 0) {
                mainCtx.resetTransform(); mainCtx.scale(dpr, dpr);
                mainCtx.clearRect(0,0, mainCanvas.width/dpr, mainCanvas.height/dpr);
                mainCtx.fillStyle = "red"; mainCtx.font = "16px Arial"; mainCtx.textAlign = "center";
                mainCtx.fillText("No hay documentos APC configurados.", mainCanvas.width/(2*dpr), mainCanvas.height/(2*dpr));
            }
        }
    </script>
</body>
</html>
