<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex,nofollow">
    <link rel="icon" href="img/favicon.png" type="image/jpeg">

    <title>Aplicación de Firma</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .logo {
            height: 60px;
            width: auto;
            object-fit: contain;
        }
        .date {
            font-weight: bold;
        }
        .document-container {
            position: relative;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            height: 700px;
            overflow: hidden;
        }
        .document-content {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: white;
            overflow: hidden;
        }
        .document-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .draggable-resizable {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px dashed #999;
            padding: 5px;
            cursor: move;
            z-index: 10;
        }
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #2196F3;
            border-radius: 50%;
            right: -6px;
            bottom: -6px;
            cursor: se-resize;
            z-index: 20;
        }
        .signature-area {
            width: 250px;
            height: 100px;
        }
        .text-area {
            width: 250px;
            height: 60px;
        }
        .draw-canvas {
            width: 100%;
            height: 100%;
            background-color: white;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .action-buttons {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        .clear-btn {
            background-color: #f44336;
        }
        .clear-btn:hover {
            background-color: #d32f2f;
        }
        .field-btn {
            background-color: #2196F3;
        }
        .field-btn:hover {
            background-color: #0b7dda;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #777;
        }
        
        @media (max-width: 600px) {
            .controls, .action-buttons {
                flex-direction: column;
            }
            button {
                width: 100%;
            }
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            white-space: nowrap;
        }
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 500px;
        }
        .modal-title {
            margin-top: 0;
            margin-bottom: 15px;
        }
        .modal-canvas {
            border: 1px solid #ccc;
            width: 100%;
            height: 200px;
        }
        .modal-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="img/favicon.png" alt="Logo" class="logo">
            <div class="date" id="current-date"></div>
        </div>

        <div id="tab-container" class="tab-container"></div>
        
        <div class="action-buttons">
            <button id="add-name-btn" class="field-btn">Dibujar Nombre</button>
            <button id="add-cedula-btn" class="field-btn">Dibujar Cédula</button>
            <button id="add-signature-btn" class="field-btn">Dibujar Firma</button>
            <button id="add-date-btn" class="field-btn">Dibujar Fecha</button>
        </div>
        
        <div class="document-container">
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
            </div>
            
            <div id="document-content" class="document-content">
                <img id="document-image" class="document-image" alt="Documento">
                
                <!-- Draggable elements will be added here -->
            </div>
        </div>
        
        <div class="controls">
            <button id="download-btn">Descargar Documento Firmado</button>
            <button id="share-btn">Compartir</button>
        </div>
        
        <div class="footer">
            <p>Todos los derechos reservados, Lulo Panamá.</p>
        </div>
    </div>

    <!-- Drawing modal -->
    <div id="drawing-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title" id="modal-title">Dibuje su firma</h3>
            <canvas id="drawing-pad" class="modal-canvas" width="460" height="200"></canvas>
            <div class="modal-buttons">
                <button id="clear-drawing-btn" class="clear-btn">Borrar</button>
                <button id="save-drawing-btn">Guardar</button>
            </div>
        </div>
    </div>
    
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // Set current date in Panama format
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
    const currentDate = new Date().toLocaleDateString('es-PA', dateOptions);
    document.getElementById('current-date').textContent = 'Panamá, ' + currentDate;
    
    // Document mapping (JPGs instead of PDFs)
    const docMapping = {
        'bac': {
            path: 'apc/apc-bac-actual.jpg',
            name: 'BAC'
        },
        'global': {
            path: 'apc/apc-global-actual.jpg',
            name: 'Global Bank'
        },
        'multi': {
            path: 'apc/apc-multi-actual.jpg',
            name: 'Multibank'
        }
    };
    
    // Get documents from URL
    const urlParams = new URLSearchParams(window.location.search);
    const documents = [];
    
    // Extract documents from URL parameters
    for (const [key, value] of urlParams.entries()) {
        if (key === 'e') {
            // Handle comma-separated values in 'e' parameter
            const docCodes = value.split(',');
            docCodes.forEach(code => {
                if (docMapping[code]) {
                    documents.push(docMapping[code]);
                }
            });
        } else if (docMapping[key]) {
            // Handle parameters like '?bac&global'
            documents.push(docMapping[key]);
        }
    }
    
    // If no documents specified, default to all
    if (documents.length === 0) {
        Object.values(docMapping).forEach(doc => documents.push(doc));
    }
    
    // Create tabs for multiple documents
    const tabContainer = document.getElementById('tab-container');
    
    let activeDocument = null;
    
    // Store elements for each document
    const documentElements = {};
    
    documents.forEach((doc, index) => {
        const tab = document.createElement('div');
        tab.classList.add('tab');
        if (index === 0) {
            tab.classList.add('active');
            activeDocument = doc;
        }
        tab.textContent = doc.name;
        tab.dataset.path = doc.path;
        
        // Initialize elements array for this document
        documentElements[doc.path] = [];
        
        tab.addEventListener('click', function() {
            // Deactivate all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            // Activate current tab
            this.classList.add('active');
            
            // Store current elements for previous document
            if (activeDocument) {
                documentElements[activeDocument.path] = [];
                document.querySelectorAll('.draggable-resizable').forEach(el => {
                    // Store element properties with percentages for responsive positioning
                    const docContent = document.getElementById('document-content');
                    const docRect = docContent.getBoundingClientRect();
                    const elRect = el.getBoundingClientRect();
                    
                    // Calculate percentage positions
                    const leftPercent = ((elRect.left - docRect.left) / docRect.width) * 100;
                    const topPercent = ((elRect.top - docRect.top) / docRect.height) * 100;
                    const widthPercent = (elRect.width / docRect.width) * 100;
                    const heightPercent = (elRect.height / docRect.height) * 100;
                    
                    const elementData = {
                        type: el.dataset.type,
                        content: el.querySelector('img') ? el.querySelector('img').src : '',
                        leftPercent: leftPercent,
                        topPercent: topPercent,
                        widthPercent: widthPercent,
                        heightPercent: heightPercent
                    };
                    documentElements[activeDocument.path].push(elementData);
                });
            }
            
            // Update active document
            activeDocument = {path: this.dataset.path, name: this.textContent};
            // Load the document
            loadDocument(this.dataset.path);
            
            // Remove existing elements
            document.querySelectorAll('.draggable-resizable').forEach(el => el.remove());
            
            // Restore elements for this document
            setTimeout(() => {
                if (documentElements[this.dataset.path]) {
                    documentElements[this.dataset.path].forEach(el => {
                        if (el.type === 'signature' || el.type === 'name' || el.type === 'cedula' || el.type === 'date') {
                            createDraggableElement(
                                el.type, 
                                el.content, 
                                `${el.leftPercent}%`, 
                                `${el.topPercent}%`, 
                                `${el.widthPercent}%`, 
                                `${el.heightPercent}%`
                            );
                        }
                    });
                }
            }, 200); // Small delay to ensure document is loaded
        });
        
        tabContainer.appendChild(tab);
    });
    
    // Load the first document if available
    if (activeDocument) {
        loadDocument(activeDocument.path);
    }
    
    // Store original document dimensions for accurate positioning
    let originalDocWidth = 0;
    let originalDocHeight = 0;
    
    // Load document image
    function loadDocument(path) {
        const loading = document.getElementById('loading');
        loading.style.display = 'flex';
        
        const documentImage = document.getElementById('document-image');
        documentImage.src = path;
        
        documentImage.onload = function() {
            loading.style.display = 'none';
            // Store original dimensions
            originalDocWidth = documentImage.naturalWidth;
            originalDocHeight = documentImage.naturalHeight;
        };
    }
    
    // Drawing modal setup
    const drawingModal = document.getElementById('drawing-modal');
    const drawingCanvas = document.getElementById('drawing-pad');
    const drawingContext = drawingCanvas.getContext('2d');
    let isDrawing = false;
    let currentDrawingType = ''; // 'signature', 'name', 'cedula', or 'date'
    let lastX, lastY;
    
    // Enhanced drawing settings
    drawingContext.lineWidth = 2.5;
    drawingContext.lineCap = 'round';
    drawingContext.lineJoin = 'round';
    drawingContext.strokeStyle = '#000000';
    
    // Handle drawing events
    drawingCanvas.addEventListener('mousedown', startDrawing);
    drawingCanvas.addEventListener('mousemove', draw);
    drawingCanvas.addEventListener('mouseup', stopDrawing);
    drawingCanvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events for mobile with improved handling
    drawingCanvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = drawingCanvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        isDrawing = true;
        lastX = x;
        lastY = y;
        
        drawingContext.beginPath();
        drawingContext.moveTo(x, y);
        
        // Draw a small dot at the start point for better visibility
        drawingContext.arc(x, y, 0.5, 0, Math.PI * 2);
        drawingContext.fill();
    });
    
    drawingCanvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        if (!isDrawing) return;
        
        const touch = e.touches[0];
        const rect = drawingCanvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        // Calculate the distance moved
        const dx = x - lastX;
        const dy = y - lastY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        // If the movement is too fast/large, interpolate points for smoother lines
        if (distance > 3) {
            const steps = Math.ceil(distance / 2);
            for (let i = 1; i <= steps; i++) {
                const px = lastX + (dx * i / steps);
                const py = lastY + (dy * i / steps);
                drawingContext.lineTo(px, py);
                drawingContext.stroke();
            }
        } else {
            drawingContext.lineTo(x, y);
            drawingContext.stroke();
        }
        
        lastX = x;
        lastY = y;
    });
    
    drawingCanvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        isDrawing = false;
    });
    
    function startDrawing(e) {
        isDrawing = true;
        const rect = drawingCanvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
        
        drawingContext.beginPath();
        drawingContext.moveTo(lastX, lastY);
        
        // Draw a small dot at the start point for better visibility
        drawingContext.arc(lastX, lastY, 0.5, 0, Math.PI * 2);
        drawingContext.fill();
    }
    
    function draw(e) {
        if (!isDrawing) return;
        
        const rect = drawingCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Calculate the distance moved
        const dx = x - lastX;
        const dy = y - lastY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        // If the movement is too fast/large, interpolate points for smoother lines
        if (distance > 3) {
            const steps = Math.ceil(distance / 2);
            for (let i = 1; i <= steps; i++) {
                const px = lastX + (dx * i / steps);
                const py = lastY + (dy * i / steps);
                drawingContext.lineTo(px, py);
                drawingContext.stroke();
            }
        } else {
            drawingContext.lineTo(x, y);
            drawingContext.stroke();
        }
        
        lastX = x;
        lastY = y;
    }
    
    function stopDrawing() {
        isDrawing = false;
    }
    
    // Add visual feedback to the drawing modal
    function showDrawingGuideline() {
        // First clear any previous guidelines
        const existingGuide = document.getElementById('drawing-guide');
        if (existingGuide) existingGuide.remove();
        
        // Create a semi-transparent overlay with instructions
        const guide = document.createElement('div');
        guide.id = 'drawing-guide';
        guide.style.position = 'absolute';
        guide.style.top = '0';
        guide.style.left = '0';
        guide.style.width = '100%';
        guide.style.height = '100%';
        guide.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        guide.style.display = 'flex';
        guide.style.flexDirection = 'column';
        guide.style.justifyContent = 'center';
        guide.style.alignItems = 'center';
        guide.style.textAlign = 'center';
        guide.style.padding = '20px';
        guide.style.zIndex = '1000';
        guide.style.fontWeight = 'bold';
        
        let guideText = '';
        if (currentDrawingType === 'signature') {
            guideText = 'Dibuje su firma aquí';
        } else if (currentDrawingType === 'name') {
            guideText = 'Escriba su nombre completo';
        } else if (currentDrawingType === 'cedula') {
            guideText = 'Escriba su número de cédula';
        } else if (currentDrawingType === 'date') {
            guideText = 'La fecha actual es: Panamá, ' + currentDate;
        }
        
        guide.innerHTML = `
            <p>${guideText}</p>
            <p>Toque aquí para comenzar</p>
        `;
        
        drawingModal.querySelector('.modal-content').appendChild(guide);
        
        // Remove the guide on click
        guide.addEventListener('click', function() {
            guide.remove();
        });
    }
    
    // Clear drawing button
    document.getElementById('clear-drawing-btn').addEventListener('click', function() {
        drawingContext.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        
        // For date, pre-fill after clearing
        if (currentDrawingType === 'date') {
            setTimeout(() => {
                drawingContext.font = '16px Arial';
                drawingContext.fillStyle = 'black';
                drawingContext.fillText('Panamá, ' + currentDate, 20, 50);
            }, 100);
        }
    });
    
    // Save drawing from modal
    document.getElementById('save-drawing-btn').addEventListener('click', function() {
        // Check if canvas is empty
        const imageData = drawingContext.getImageData(0, 0, drawingCanvas.width, drawingCanvas.height).data;
        let hasContent = false;
        for (let i = 0; i < imageData.length; i += 4) {
            if (imageData[i + 3] > 0) { // Check alpha channel
                hasContent = true;
                break;
            }
        }
        
        // If empty and it's a date, pre-fill with current date
        if (!hasContent && currentDrawingType === 'date') {
            drawingContext.font = '16px Arial';
            drawingContext.fillStyle = 'black';
            drawingContext.fillText('Panamá, ' + currentDate, 20, 50);
        } else if (!hasContent) {
            alert('Por favor dibuje algo antes de guardar.');
            return;
        }
        
        const drawingImage = drawingCanvas.toDataURL('image/png');
        
        // Get document content dimensions for percentage calculations
        const docContent = document.getElementById('document-content');
        const docRect = docContent.getBoundingClientRect();
        
        // Check if this type of element already exists
        const existingElement = document.querySelector(`.draggable-resizable[data-type="${currentDrawingType}"]`);
        
        if (existingElement) {
            // Update existing element
            const img = existingElement.querySelector('img');
            if (img) {
                img.src = drawingImage;
            }
        } else {
            // Create new element with percentage-based positions
            let left, top, width, height;
            
            // Position elements differently based on type using percentages
            if (currentDrawingType === 'signature') {
                left = '5%';
                top = '60%';
                width = '30%';
                height = '15%';
            } else if (currentDrawingType === 'name') {
                left = '5%';
                top = '10%';
                width = '30%';
                height = '8%';
            } else if (currentDrawingType === 'cedula') {
                left = '5%';
                top = '20%';
                width = '30%';
                height = '8%';
            } else if (currentDrawingType === 'date') {
                left = '5%';
                top = '30%';
                width = '30%';
                height = '6%';
            }
            
            createDraggableElement(currentDrawingType, drawingImage, left, top, width, height);
        }
        
        // Hide modal
        drawingModal.style.display = 'none';
    });
    
    // Open modal with appropriate title and guidance
    function showDrawingModal(type) {
        currentDrawingType = type;
        
        // Set appropriate title
        const modalTitle = document.getElementById('modal-title');
        if (type === 'signature') {
            modalTitle.textContent = 'Dibuje su firma';
        } else if (type === 'name') {
            modalTitle.textContent = 'Dibuje su nombre';
        } else if (type === 'cedula') {
            modalTitle.textContent = 'Dibuje su cédula';
        } else if (type === 'date') {
            modalTitle.textContent = 'Dibuje la fecha';
        }
        
        // Clear canvas and show modal
        drawingContext.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        drawingModal.style.display = 'flex';
        
        // Show drawing guidelines with instructions
        showDrawingGuideline();
        
        // If it's a date element, draw the current date as a starting point
        if (type === 'date') {
            setTimeout(() => {
                if (document.getElementById('drawing-guide') === null) { // Only if guide is dismissed
                    drawingContext.font = '16px Arial';
                    drawingContext.fillStyle = 'black';
                    drawingContext.fillText('Panamá, ' + currentDate, 20, 50);
                }
            }, 300);
        }
    }
    
    // Button event listeners for drawing elements
    document.getElementById('add-name-btn').addEventListener('click', function() {
        showDrawingModal('name');
    });
    
    document.getElementById('add-cedula-btn').addEventListener('click', function() {
        showDrawingModal('cedula');
    });
    
    document.getElementById('add-signature-btn').addEventListener('click', function() {
        showDrawingModal('signature');
    });
    
    document.getElementById('add-date-btn').addEventListener('click', function() {
        showDrawingModal('date');
    });
    
    // Create draggable and resizable element
    function createDraggableElement(type, content, left = '5%', top = '40%', width = null, height = null) {
        const docContent = document.getElementById('document-content');
        
        // Create element container
        const elementArea = document.createElement('div');
        elementArea.className = 'draggable-resizable';
        elementArea.dataset.type = type;
        elementArea.style.left = left;
        elementArea.style.top = top;
        
        // Set default size based on type using percentages
        if (type === 'signature') {
            elementArea.style.width = width || '30%';
            elementArea.style.height = height || '15%';
        } else if (type === 'date') {
            elementArea.style.width = width || '25%';
            elementArea.style.height = height || '6%';
        } else {
            elementArea.style.width = width || '25%';
            elementArea.style.height = height || '8%';
        }
        
        // Create content image
        const img = document.createElement('img');
        img.src = content;
        img.style.width = '100%';
        img.style.height = '100%';
        
        // Add resize handle
        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'resize-handle';
        
        elementArea.appendChild(img);
        elementArea.appendChild(resizeHandle);
        docContent.appendChild(elementArea);
        
        // Make draggable and resizable
        makeDraggableResizable(elementArea, resizeHandle);
    }
    
    // Make elements draggable and resizable
    function makeDraggableResizable(element, resizeHandle) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        let resizing = false;
        let startWidth, startHeight, startX, startY;
        
        // Store original aspect ratio
        let originalAspectRatio;
        
        // Initialize aspect ratio
        function initAspectRatio() {
            const style = window.getComputedStyle(element);
            const width = parseFloat(style.width);
            const height = parseFloat(style.height);
            originalAspectRatio = width / height;
        }
        
        // Call once on creation
        initAspectRatio();
        
        // Dragging functionality
        element.onmousedown = dragMouseDown;
        element.ontouchstart = dragTouchStart;
        
        // Resizing functionality
        resizeHandle.onmousedown = resizeMouseDown;
        resizeHandle.ontouchstart = resizeTouchStart;
        
        function dragMouseDown(e) {
            if (e.target === resizeHandle) return;
            
            e = e || window.event;
            e.preventDefault();
            // Get the mouse cursor position at startup
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // Call a function whenever the cursor moves
            document.onmousemove = elementDrag;
            
            // Highlight the active element
            highlightActiveElement(element);
        }
        
        function dragTouchStart(e) {
            if (e.target === resizeHandle) return;
            
            e = e || window.event;
            e.preventDefault();
            // Get the touch position at startup
            const touch = e.touches[0];
            pos3 = touch.clientX;
            pos4 = touch.clientY;
            document.ontouchend = closeDragElement;
            // Call a function whenever the finger moves
            document.ontouchmove = elementTouchDrag;
            
            // Highlight the active element
            highlightActiveElement(element);
        }
        
        function elementDrag(e) {
            if (resizing) return;
            
            e = e || window.event;
            e.preventDefault();
            // Calculate the new cursor position
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            
            // Get the document content container dimensions
            const docContent = document.getElementById('document-content');
            const docRect = docContent.getBoundingClientRect();
            
            // Calculate new position
            let newTop = element.offsetTop - pos2;
            let newLeft = element.offsetLeft - pos1;
            
            // Ensure the element stays within bounds
            newTop = Math.max(0, Math.min(newTop, docRect.height - element.offsetHeight));
            newLeft = Math.max(0, Math.min(newLeft, docRect.width - element.offsetWidth));
            
            // Convert to percentage for responsive positioning
            const topPercent = (newTop / docRect.height) * 100;
            const leftPercent = (newLeft / docRect.width) * 100;
            
            // Set the element's new position in percentages
            element.style.top = topPercent + '%';
            element.style.left = leftPercent + '%';
        }
        
        function elementTouchDrag(e) {
            if (resizing) return;
            
            e = e || window.event;
            e.preventDefault();
            // Calculate the new touch position
            const touch = e.touches[0];
            pos1 = pos3 - touch.clientX;
            pos2 = pos4 - touch.clientY;
            pos3 = touch.clientX;
            pos4 = touch.clientY;
            
            // Get the document content container dimensions
            const docContent = document.getElementById('document-content');
            const docRect = docContent.getBoundingClientRect();
            
            // Calculate new position
            let newTop = element.offsetTop - pos2;
            let newLeft = element.offsetLeft - pos1;
            
            // Ensure the element stays within bounds
            newTop = Math.max(0, Math.min(newTop, docRect.height - element.offsetHeight));
            newLeft = Math.max(0, Math.min(newLeft, docRect.width - element.offsetWidth));
            
            // Convert to percentage for responsive positioning
            const topPercent = (newTop / docRect.height) * 100;
            const leftPercent = (newLeft / docRect.width) * 100;
            
            // Set the element's new position in percentages
            element.style.top = topPercent + '%';
            element.style.left = leftPercent + '%';
        }
        
        function resizeMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            e.stopPropagation();
            
            resizing = true;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = parseInt(document.defaultView.getComputedStyle(element).width, 10);
            startHeight = parseInt(document.defaultView.getComputedStyle(element).height, 10);
            
            // Initialize aspect ratio if not already set
            if (!originalAspectRatio) {
                originalAspectRatio = startWidth / startHeight;
            }
            
            document.onmouseup = closeResizeElement;
            document.onmousemove = elementResize;
            
            // Highlight the active element
            highlightActiveElement(element);
        }
        
        function resizeTouchStart(e) {
            e = e || window.event;
            e.preventDefault();
            e.stopPropagation();
            
            resizing = true;
            const touch = e.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;
            startWidth = parseInt(document.defaultView.getComputedStyle(element).width, 10);
            startHeight = parseInt(document.defaultView.getComputedStyle(element).height, 10);
            
            // Initialize aspect ratio if not already set
            if (!originalAspectRatio) {
                originalAspectRatio = startWidth / startHeight;
            }
            
            document.ontouchend = closeResizeElement;
            document.ontouchmove = elementTouchResize;
            
            // Highlight the active element
            highlightActiveElement(element);
        }
        
        function elementResize(e) {
            e = e || window.event;
            e.preventDefault();
            
            // Get the document content container dimensions
            const docContent = document.getElementById('document-content');
            const docRect = docContent.getBoundingClientRect();
            
            // Calculate new width based on mouse movement
            const width = Math.max(50, startWidth + e.clientX - startX);
            
            // Calculate height to maintain aspect ratio
            const height = width / originalAspectRatio;
            
            // Calculate width as percentage of container
            const widthPercent = (width / docRect.width) * 100;
            const heightPercent = (height / docRect.height) * 100;
            
            // Apply if height meets minimum requirement and doesn't exceed container
            if (height >= 20 && widthPercent <= 98 && heightPercent <= 98) {
                element.style.width = widthPercent + '%';
                element.style.height = heightPercent + '%';
            }
        }
        
        function elementTouchResize(e) {
            e = e || window.event;
            e.preventDefault();
            
            const touch = e.touches[0];
            
            // Get the document content container dimensions
            const docContent = document.getElementById('document-content');
            const docRect = docContent.getBoundingClientRect();
            
            // Calculate new width based on touch movement
            const width = Math.max(50, startWidth + touch.clientX - startX);
            
            // Calculate height to maintain aspect ratio
            const height = width / originalAspectRatio;
            
            // Calculate width as percentage of container
            const widthPercent = (width / docRect.width) * 100;
            const heightPercent = (height / docRect.height) * 100;
            
            // Apply if height meets minimum requirement and doesn't exceed container
            if (height >= 20 && widthPercent <= 98 && heightPercent <= 98) {
                element.style.width = widthPercent + '%';
                element.style.height = heightPercent + '%';
            }
        }
        
        function closeDragElement() {
            // Stop moving when mouse/touch is released
            document.onmouseup = null;
            document.onmousemove = null;
            document.ontouchend = null;
            document.ontouchmove = null;
            
            // Remove highlight from all elements
            document.querySelectorAll('.draggable-resizable').forEach(el => {
                el.style.boxShadow = 'none';
                el.style.borderColor = '#999';
            });
        }
        
        function closeResizeElement() {
            // Stop resizing when mouse/touch is released
            document.onmouseup = null;
            document.onmousemove = null;
            document.ontouchend = null;
            document.ontouchmove = null;
            resizing = false;
            
            // Remove highlight from all elements
            document.querySelectorAll('.draggable-resizable').forEach(el => {
                el.style.boxShadow = 'none';
                el.style.borderColor = '#999';
            });
        }
        
        // Function to highlight the active element
        function highlightActiveElement(el) {
            // Remove highlight from all elements
            document.querySelectorAll('.draggable-resizable').forEach(element => {
                element.style.boxShadow = 'none';
                element.style.borderColor = '#999';
            });
            
            // Add highlight to the active element
            el.style.boxShadow = '0 0 8px rgba(33, 150, 243, 0.8)';
            el.style.borderColor = '#2196F3';
        }
    }
    
    // Download button
    document.getElementById('download-btn').addEventListener('click', function() {
        if (!activeDocument) return;
        
        const loadingElement = document.getElementById('loading');
        loadingElement.style.display = 'flex';
        
        setTimeout(() => {
            // Create a canvas to generate the final document
            const finalCanvas = document.createElement('canvas');
            const docImage = document.getElementById('document-image');
            
            // Set canvas size to match the image's natural dimensions
            finalCanvas.width = docImage.naturalWidth;
            finalCanvas.height = docImage.naturalHeight;
            
            const finalContext = finalCanvas.getContext('2d');
            
            // Draw the document image
            finalContext.drawImage(docImage, 0, 0, finalCanvas.width, finalCanvas.height);
            
            // Get document container dimensions
            const docContainer = document.getElementById('document-content');
            const docRect = docContainer.getBoundingClientRect();
            
            // Draw all draggable elements in their positions
            document.querySelectorAll('.draggable-resizable').forEach(el => {
                // Get element's style and calculate its position and size relative to the container
                const style = window.getComputedStyle(el);
                
                // Parse percentage values
                const leftPercent = parseFloat(style.left) / 100;
                const topPercent = parseFloat(style.top) / 100;
                const widthPercent = parseFloat(style.width) / 100;
                const heightPercent = parseFloat(style.height) / 100;

// Calculate absolute positions and dimensions on the final canvas
                const finalLeft = leftPercent * finalCanvas.width;
                const finalTop = topPercent * finalCanvas.height;
                const finalWidth = widthPercent * finalCanvas.width;
                const finalHeight = heightPercent * finalCanvas.height;

// Get the image from the element
const img = el.querySelector('img');
if (img) {
    // Draw the element's image onto the final canvas
    finalContext.drawImage(img, finalLeft, finalTop, finalWidth, finalHeight);
}
});

// Create download link
const downloadLink = document.createElement('a');
downloadLink.download = `${activeDocument.name.replace(/\s+/g, '-')}-firmado.png`;

// Use PNG format for better quality
finalCanvas.toBlob(function(blob) {
    const url = URL.createObjectURL(blob);
    downloadLink.href = url;
    
    // Trigger download
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
    
    // Release object URL
    setTimeout(() => {
        URL.revokeObjectURL(url);
        loadingElement.style.display = 'none';
    }, 100);
}, 'image/png');
}, 500); // Small delay to ensure loading indicator appears
});

// Close modal button event
document.getElementById('close-modal-btn').addEventListener('click', function() {
    drawingModal.style.display = 'none';
});

// Close modal when clicking outside of it
window.addEventListener('click', function(e) {
    if (e.target === drawingModal) {
        drawingModal.style.display = 'none';
    }
});

// Delete button for elements
document.getElementById('delete-btn').addEventListener('click', function() {
    // Find element with highlight
    const activeElement = document.querySelector('.draggable-resizable[style*="box-shadow"]');
    if (activeElement) {
        activeElement.remove();
    } else {
        alert('Seleccione un elemento para eliminar');
    }
});

// Adjust canvas size when window is resized
function adjustCanvasSize() {
    // Set canvas dimensions to match the displayed size
    drawingCanvas.width = drawingCanvas.offsetWidth;
    drawingCanvas.height = drawingCanvas.offsetHeight;
    
    // Maintain drawing settings
    drawingContext.lineWidth = 2.5;
    drawingContext.lineCap = 'round';
    drawingContext.lineJoin = 'round';
    drawingContext.strokeStyle = '#000000';
}

// Initialize canvas size and adjust on resize
adjustCanvasSize();
window.addEventListener('resize', adjustCanvasSize);

// Add mobile-friendly tooltip instructions
function addMobileTooltips() {
    const tooltips = {
        'add-signature-btn': 'Toque para agregar su firma',
        'add-name-btn': 'Toque para agregar su nombre',
        'add-cedula-btn': 'Toque para agregar su cédula',
        'add-date-btn': 'Toque para agregar la fecha',
        'delete-btn': 'Eliminar elemento seleccionado',
        'download-btn': 'Descargar documento firmado'
    };
    
    Object.keys(tooltips).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            // Add tooltip element
            const tooltip = document.createElement('span');
            tooltip.className = 'tooltip';
            tooltip.textContent = tooltips[id];
            element.appendChild(tooltip);
            
            // Show tooltip on touch
            element.addEventListener('touchstart', function() {
                tooltip.style.visibility = 'visible';
                tooltip.style.opacity = '1';
                
                // Hide after delay
                setTimeout(() => {
                    tooltip.style.visibility = 'hidden';
                    tooltip.style.opacity = '0';
                }, 2000);
            });
        }
    });
}

// Add help button functionality
document.getElementById('help-btn').addEventListener('click', function() {
    // Create and show help overlay
    const helpOverlay = document.createElement('div');
    helpOverlay.className = 'help-overlay';
    helpOverlay.innerHTML = `
        <div class="help-content">
            <h3>Ayuda rápida</h3>
            <ul>
                <li><strong>Agregar elementos:</strong> Use los botones superiores para agregar firma, nombre, cédula o fecha</li>
                <li><strong>Mover elementos:</strong> Toque y arrastre para posicionar</li>
                <li><strong>Cambiar tamaño:</strong> Arrastre la esquina inferior derecha</li>
                <li><strong>Eliminar:</strong> Seleccione un elemento y presione el botón de eliminar</li>
                <li><strong>Cambiar documentos:</strong> Use las pestañas superiores</li>
            </ul>
            <button id="close-help">Cerrar ayuda</button>
        </div>
    `;
    
    document.body.appendChild(helpOverlay);
    
    // Add close functionality
    document.getElementById('close-help').addEventListener('click', function() {
        helpOverlay.remove();
    });
    
    // Close on click outside
    helpOverlay.addEventListener('click', function(e) {
        if (e.target === helpOverlay) {
            helpOverlay.remove();
        }
    });
});

// Enhanced touch feedback for better UX
document.querySelectorAll('.button').forEach(button => {
    button.addEventListener('touchstart', function() {
        this.classList.add('button-active');
    });
    
    button.addEventListener('touchend', function() {
        this.classList.remove('button-active');
        
        // Provide haptic feedback if available
        if (window.navigator && window.navigator.vibrate) {
            window.navigator.vibrate(50);
        }
    });
});

// Add guidance indicators for new users
function showInitialGuidance() {
    // Check if this is first visit
    if (!localStorage.getItem('hasVisitedBefore')) {
        // Create guided tour overlay
        const guidanceOverlay = document.createElement('div');
        guidanceOverlay.className = 'guidance-overlay';
        guidanceOverlay.innerHTML = `
            <div class="guidance-content">
                <h3>Bienvenido al firmador de documentos</h3>
                <p>Le guiaremos en los pasos básicos:</p>
                <ol>
                    <li>Primero, dibuje su firma utilizando el botón "Firma"</li>
                    <li>Posicione los elementos arrastrándolos sobre el documento</li>
                    <li>Cuando termine, descargue su documento firmado</li>
                </ol>
                <button id="start-using">Comenzar a usar</button>
            </div>
        `;
        
        document.body.appendChild(guidanceOverlay);
        
        // Remove guidance and mark as visited
        document.getElementById('start-using').addEventListener('click', function() {
            guidanceOverlay.remove();
            localStorage.setItem('hasVisitedBefore', 'true');
            
            // Highlight signature button as next step
            const signatureBtn = document.getElementById('add-signature-btn');
            signatureBtn.classList.add('highlight-button');
            setTimeout(() => {
                signatureBtn.classList.remove('highlight-button');
            }, 3000);
        });
    }
}

// Mobile enhancements
if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
    // Add mobile specific enhancements
    document.body.classList.add('mobile-device');
    addMobileTooltips();
    
    // Improve touch targets
    document.querySelectorAll('.button, .tab').forEach(el => {
        el.classList.add('touch-friendly');
    });
}

// Show initial guidance and initialize mobile features
showInitialGuidance();
});    
    </script>
</body>
</html>
