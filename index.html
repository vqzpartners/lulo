<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex,nofollow">
    <link rel="icon" href="img/favicon.png" type="image/jpeg">

    <title>Aplicación de Firma</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .logo {
            height: 60px;
            width: auto;
            object-fit: contain;
        }
        .date {
            font-weight: bold;
        }
        .document-container {
            position: relative;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            height: 700px;
            overflow: hidden;
        }
        .document-content {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: white;
            overflow: hidden;
        }
        .document-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .draggable-resizable {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px dashed #999;
            padding: 5px;
            cursor: move;
            z-index: 10;
        }
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #2196F3;
            border-radius: 50%;
            right: -6px;
            bottom: -6px;
            cursor: se-resize;
            z-index: 20;
        }
        .signature-area {
            width: 250px;
            height: 100px;
        }
        .text-area {
            width: 250px;
            height: 60px;
        }
        .draw-canvas {
            width: 100%;
            height: 100%;
            background-color: white;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .action-buttons {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        .clear-btn {
            background-color: #f44336;
        }
        .clear-btn:hover {
            background-color: #d32f2f;
        }
        .field-btn {
            background-color: #2196F3;
        }
        .field-btn:hover {
            background-color: #0b7dda;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #777;
        }
        
        @media (max-width: 600px) {
            .controls, .action-buttons {
                flex-direction: column;
            }
            button {
                width: 100%;
            }
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            white-space: nowrap;
        }
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 500px;
        }
        .modal-title {
            margin-top: 0;
            margin-bottom: 15px;
        }
        .modal-canvas {
            border: 1px solid #ccc;
            width: 100%;
            height: 200px;
        }
        .modal-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="img/favicon.png" alt="Logo" class="logo">
            <div class="date" id="current-date"></div>
        </div>

        <div id="tab-container" class="tab-container"></div>
        
        <div class="action-buttons">
            <button id="add-name-btn" class="field-btn">Dibujar Nombre</button>
            <button id="add-cedula-btn" class="field-btn">Dibujar Cédula</button>
            <button id="add-signature-btn" class="field-btn">Dibujar Firma</button>
            <button id="add-date-btn" class="field-btn">Dibujar Fecha</button>
        </div>
        
        <div class="document-container">
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
            </div>
            
            <div id="document-content" class="document-content">
                <img id="document-image" class="document-image" alt="Documento">
                
                <!-- Draggable elements will be added here -->
            </div>
        </div>
        
        <div class="controls">
            <button id="download-btn">Descargar Documento Firmado</button>
            <button id="share-btn">Compartir</button>
        </div>
        
        <div class="footer">
            <p>Todos los derechos reservados, Lulo Panamá.</p>
        </div>
    </div>

    <!-- Drawing modal -->
    <div id="drawing-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title" id="modal-title">Dibuje su firma</h3>
            <canvas id="drawing-pad" class="modal-canvas" width="460" height="200"></canvas>
            <div class="modal-buttons">
                <button id="clear-drawing-btn" class="clear-btn">Borrar</button>
                <button id="save-drawing-btn">Guardar</button>
            </div>
        </div>
    </div>
    
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // Set current date in Panama format
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
    const currentDate = new Date().toLocaleDateString('es-PA', dateOptions);
    document.getElementById('current-date').textContent = 'Panamá, ' + currentDate;
    
    // Document mapping (JPGs instead of PDFs)
    const docMapping = {
        'bac': {
            path: 'apc/apc-bac-actual.jpg',
            name: 'BAC'
        },
        'global': {
            path: 'apc/apc-global-actual.jpg',
            name: 'Global Bank'
        },
        'multi': {
            path: 'apc/apc-multi-actual.jpg',
            name: 'Multibank'
        }
    };
    
    // Get documents from URL
    const urlParams = new URLSearchParams(window.location.search);
    const documents = [];
    
    // Extract documents from URL parameters
    for (const [key, value] of urlParams.entries()) {
        if (key === 'e') {
            // Handle comma-separated values in 'e' parameter
            const docCodes = value.split(',');
            docCodes.forEach(code => {
                if (docMapping[code]) {
                    documents.push(docMapping[code]);
                }
            });
        } else if (docMapping[key]) {
            // Handle parameters like '?bac&global'
            documents.push(docMapping[key]);
        }
    }
    
    // If no documents specified, default to all
    if (documents.length === 0) {
        Object.values(docMapping).forEach(doc => documents.push(doc));
    }
    
    // Create tabs for multiple documents
    const tabContainer = document.getElementById('tab-container');
    
    let activeDocument = null;
    
    // Store elements for each document
    const documentElements = {};
    
    documents.forEach((doc, index) => {
        const tab = document.createElement('div');
        tab.classList.add('tab');
        if (index === 0) {
            tab.classList.add('active');
            activeDocument = doc;
        }
        tab.textContent = doc.name;
        tab.dataset.path = doc.path;
        
        // Initialize elements array for this document
        documentElements[doc.path] = [];
        
        tab.addEventListener('click', function() {
            // Deactivate all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            // Activate current tab
            this.classList.add('active');
            
            // Store current elements for previous document
            if (activeDocument) {
                documentElements[activeDocument.path] = [];
                document.querySelectorAll('.draggable-resizable').forEach(el => {
                    // Store element properties
                    const elementData = {
                        type: el.dataset.type,
                        content: el.querySelector('img') ? el.querySelector('img').src : '',
                        left: el.style.left,
                        top: el.style.top,
                        width: el.style.width,
                        height: el.style.height
                    };
                    documentElements[activeDocument.path].push(elementData);
                });
            }
            
            // Update active document
            activeDocument = {path: this.dataset.path, name: this.textContent};
            // Load the document
            loadDocument(this.dataset.path);
            
            // Remove existing elements
            document.querySelectorAll('.draggable-resizable').forEach(el => el.remove());
            
            // Restore elements for this document
            setTimeout(() => {
                if (documentElements[this.dataset.path]) {
                    documentElements[this.dataset.path].forEach(el => {
                        if (el.type === 'signature') {
                            createDraggableElement('signature', el.content, el.left, el.top, el.width, el.height);
                        } else if (el.type === 'name') {
                            createDraggableElement('name', el.content, el.left, el.top, el.width, el.height);
                        } else if (el.type === 'cedula') {
                            createDraggableElement('cedula', el.content, el.left, el.top, el.width, el.height);
                        } else if (el.type === 'date') {
                            createDraggableElement('date', el.content, el.left, el.top, el.width, el.height);
                        }
                    });
                }
            }, 200); // Small delay to ensure document is loaded
        });
        
        tabContainer.appendChild(tab);
    });
    
    // Load the first document if available
    if (activeDocument) {
        loadDocument(activeDocument.path);
    }
    
    // Load document image
    function loadDocument(path) {
        const loading = document.getElementById('loading');
        loading.style.display = 'flex';
        
        const documentImage = document.getElementById('document-image');
        documentImage.src = path;
        
        documentImage.onload = function() {
            loading.style.display = 'none';
        };
    }
    
    // Drawing modal setup
    const drawingModal = document.getElementById('drawing-modal');
    const drawingCanvas = document.getElementById('drawing-pad');
    const drawingContext = drawingCanvas.getContext('2d');
    let isDrawing = false;
    let currentDrawingType = ''; // 'signature', 'name', 'cedula', or 'date'
    
    drawingContext.lineWidth = 2;
    drawingContext.strokeStyle = '#000000';
    
    // Handle drawing events
    drawingCanvas.addEventListener('mousedown', startDrawing);
    drawingCanvas.addEventListener('mousemove', draw);
    drawingCanvas.addEventListener('mouseup', stopDrawing);
    drawingCanvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events for mobile
    drawingCanvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        drawingCanvas.dispatchEvent(mouseEvent);
    });
    
    drawingCanvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        drawingCanvas.dispatchEvent(mouseEvent);
    });
    
    drawingCanvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup');
        drawingCanvas.dispatchEvent(mouseEvent);
    });
    
    function startDrawing(e) {
        isDrawing = true;
        drawingContext.beginPath();
        drawingContext.moveTo(
            e.clientX - drawingCanvas.getBoundingClientRect().left,
            e.clientY - drawingCanvas.getBoundingClientRect().top
        );
    }
    
    function draw(e) {
        if (!isDrawing) return;
        
        drawingContext.lineTo(
            e.clientX - drawingCanvas.getBoundingClientRect().left,
            e.clientY - drawingCanvas.getBoundingClientRect().top
        );
        drawingContext.stroke();
    }
    
    function stopDrawing() {
        isDrawing = false;
    }
    
    // Clear drawing button
    document.getElementById('clear-drawing-btn').addEventListener('click', function() {
        drawingContext.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
    });
    
    // Save drawing from modal
    document.getElementById('save-drawing-btn').addEventListener('click', function() {
        const drawingImage = drawingCanvas.toDataURL('image/png');
        
        // Check if this type of element already exists
        const existingElement = document.querySelector(`.draggable-resizable[data-type="${currentDrawingType}"]`);
        
        if (existingElement) {
            // Update existing element
            const img = existingElement.querySelector('img');
            if (img) {
                img.src = drawingImage;
            }
        } else {
            // Create new element
            let left = '50px';
            let top = '400px';
            
            // Position elements differently based on type
            if (currentDrawingType === 'name') {
                top = '450px';
            } else if (currentDrawingType === 'cedula') {
                top = '500px';
            } else if (currentDrawingType === 'date') {
                top = '550px';
            }
            
            createDraggableElement(currentDrawingType, drawingImage, left, top);
        }
        
        // Hide modal
        drawingModal.style.display = 'none';
    });
    
    // Open modal with appropriate title
    function showDrawingModal(type) {
        currentDrawingType = type;
        
        // Set appropriate title
        const modalTitle = document.getElementById('modal-title');
        if (type === 'signature') {
            modalTitle.textContent = 'Dibuje su firma';
        } else if (type === 'name') {
            modalTitle.textContent = 'Dibuje su nombre';
        } else if (type === 'cedula') {
            modalTitle.textContent = 'Dibuje su cédula';
        } else if (type === 'date') {
            modalTitle.textContent = 'Dibuje la fecha';
        }
        
        // Clear canvas and show modal
        drawingContext.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        drawingModal.style.display = 'flex';
        
        // If it's a date element, draw the current date as a starting point
        if (type === 'date') {
            drawingContext.font = '16px Arial';
            drawingContext.fillStyle = 'black';
            drawingContext.fillText('Panamá, ' + currentDate, 50, 50);
        }
    }
    
    // Button event listeners for drawing elements
    document.getElementById('add-name-btn').addEventListener('click', function() {
        showDrawingModal('name');
    });
    
    document.getElementById('add-cedula-btn').addEventListener('click', function() {
        showDrawingModal('cedula');
    });
    
    document.getElementById('add-signature-btn').addEventListener('click', function() {
        showDrawingModal('signature');
    });
    
    document.getElementById('add-date-btn').addEventListener('click', function() {
        showDrawingModal('date');
    });
    
    // Create draggable and resizable element
    function createDraggableElement(type, content, left = '50px', top = '400px', width = null, height = null) {
        const docContent = document.getElementById('document-content');
        
        // Create element container
        const elementArea = document.createElement('div');
        elementArea.className = 'draggable-resizable';
        elementArea.dataset.type = type;
        elementArea.style.left = left;
        elementArea.style.top = top;
        
        // Set default size based on type
        if (type === 'signature') {
            elementArea.style.width = width || '250px';
            elementArea.style.height = height || '100px';
        } else if (type === 'date') {
            elementArea.style.width = width || '200px';
            elementArea.style.height = height || '30px';
        } else {
            elementArea.style.width = width || '200px';
            elementArea.style.height = height || '60px';
        }
        
        // Create content image
        const img = document.createElement('img');
        img.src = content;
        img.style.width = '100%';
        img.style.height = '100%';
        
        // Add resize handle
        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'resize-handle';
        
        elementArea.appendChild(img);
        elementArea.appendChild(resizeHandle);
        docContent.appendChild(elementArea);
        
        // Make draggable and resizable
        makeDraggableResizable(elementArea, resizeHandle);
    }
    
    // Make elements draggable and resizable
    function makeDraggableResizable(element, resizeHandle) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        let resizing = false;
        let startWidth, startHeight, startX, startY;
        
        // Dragging functionality
        element.onmousedown = dragMouseDown;
        element.ontouchstart = dragTouchStart;
        
        // Resizing functionality
        resizeHandle.onmousedown = resizeMouseDown;
        resizeHandle.ontouchstart = resizeTouchStart;
        
        function dragMouseDown(e) {
            if (e.target === resizeHandle) return;
            
            e = e || window.event;
            e.preventDefault();
            // Get the mouse cursor position at startup
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // Call a function whenever the cursor moves
            document.onmousemove = elementDrag;
        }
        
        function dragTouchStart(e) {
            if (e.target === resizeHandle) return;
            
            e = e || window.event;
            e.preventDefault();
            // Get the touch position at startup
            const touch = e.touches[0];
            pos3 = touch.clientX;
            pos4 = touch.clientY;
            document.ontouchend = closeDragElement;
            // Call a function whenever the finger moves
            document.ontouchmove = elementTouchDrag;
        }
        
        function elementDrag(e) {
            if (resizing) return;
            
            e = e || window.event;
            e.preventDefault();
            // Calculate the new cursor position
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // Set the element's new position
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
        }
        
        function elementTouchDrag(e) {
            if (resizing) return;
            
            e = e || window.event;
            e.preventDefault();
            // Calculate the new touch position
            const touch = e.touches[0];
            pos1 = pos3 - touch.clientX;
            pos2 = pos4 - touch.clientY;
            pos3 = touch.clientX;
            pos4 = touch.clientY;
            // Set the element's new position
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
        }
        
        function resizeMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            e.stopPropagation();
            
            resizing = true;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = parseInt(document.defaultView.getComputedStyle(element).width, 10);
            startHeight = parseInt(document.defaultView.getComputedStyle(element).height, 10);
            
            document.onmouseup = closeResizeElement;
            document.onmousemove = elementResize;
        }
        
        function resizeTouchStart(e) {
            e = e || window.event;
            e.preventDefault();
            e.stopPropagation();
            
            resizing = true;
            const touch = e.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;
            startWidth = parseInt(document.defaultView.getComputedStyle(element).width, 10);
            startHeight = parseInt(document.defaultView.getComputedStyle(element).height, 10);
            
            document.ontouchend = closeResizeElement;
            document.ontouchmove = elementTouchResize;
        }
        
        function elementResize(e) {
            e = e || window.event;
            e.preventDefault();
            
            // Calculate new width and height
            const width = startWidth + e.clientX - startX;
            const height = startHeight + e.clientY - startY;
            
            // Apply minimum size constraints
            if (width > 50) {
                element.style.width = width + 'px';
            }
            
            if (height > 20) {
                element.style.height = height + 'px';
            }
        }
        
        function elementTouchResize(e) {
            e = e || window.event;
            e.preventDefault();
            
            const touch = e.touches[0];
            
            // Calculate new width and height
            const width = startWidth + touch.clientX - startX;
            const height = startHeight + touch.clientY - startY;
            
            // Apply minimum size constraints
            if (width > 50) {
                element.style.width = width + 'px';
            }
            
            if (height > 20) {
                element.style.height = height + 'px';
            }
        }
        
        function closeDragElement() {
            // Stop moving when mouse/touch is released
            document.onmouseup = null;
            document.onmousemove = null;
            document.ontouchend = null;
            document.ontouchmove = null;
        }
        
        function closeResizeElement() {
            // Stop resizing when mouse/touch is released
            document.onmouseup = null;
            document.onmousemove = null;
            document.ontouchend = null;
            document.ontouchmove = null;
            resizing = false;
        }
    }
    
    // Download button
    document.getElementById('download-btn').addEventListener('click', function() {
        if (!activeDocument) return;
        
        const loadingElement = document.getElementById('loading');
        loadingElement.style.display = 'flex';
        
        setTimeout(() => {
            // Create a canvas to generate the final document
            const finalCanvas = document.createElement('canvas');
            const docImage = document.getElementById('document-image');
            
            // Set canvas size to match the image
            finalCanvas.width = docImage.naturalWidth;
            finalCanvas.height = docImage.naturalHeight;
            
            const finalContext = finalCanvas.getContext('2d');
            
            // Draw the document image
            finalContext.drawImage(docImage, 0, 0, finalCanvas.width, finalCanvas.height);
            
            // Draw all draggable elements in their positions
            document.querySelectorAll('.draggable-resizable').forEach(el => {
                const rect = el.getBoundingClientRect();
                const docRect = document.getElementById('document-content').getBoundingClientRect();
                
                // Calculate position percentage
                const percentX = (rect.left - docRect.left) / docRect.width;
                const percentY = (rect.top - docRect.top) / docRect.height;
                
                // Calculate size percentage
                const percentWidth = rect.width / docRect.width;
                const percentHeight = rect.height / docRect.height;
                
                // Position and size on the final canvas
                const canvasX = percentX * finalCanvas.width;
                const canvasY = percentY * finalCanvas.height;
                const canvasWidth = percentWidth * finalCanvas.width;
                const canvasHeight = percentHeight * finalCanvas.height;
                
                // Draw the element
                const img = el.querySelector('img');
                if (img && img.src) {
                    const tempImg = new Image();
                    tempImg.src = img.src;
                    finalContext.drawImage(tempImg, canvasX, canvasY, canvasWidth, canvasHeight);
                }
            });
            
            // Convert to image and download
            const image = finalCanvas.toDataURL('image/jpeg', 0.95);
            
            const downloadLink = document.createElement('a');
            downloadLink.href = image;
            downloadLink.download = `documento-firmado-${activeDocument.name.toLowerCase().replace(/\s/g, '-')}.jpg`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            loadingElement.style.display = 'none';
        }, 500);
    });
    
    // Share button for mobile
    document.getElementById('share-btn').addEventListener('click', function() {
        if (!activeDocument) return;
        
        const loadingElement = document.getElementById('loading');
        loadingElement.style.display = 'flex';
        
        setTimeout(() => {
            // Create a canvas to generate the final document (same as download)
            const finalCanvas = document.createElement('canvas');
            const docImage = document.getElementById('document-image');
            
            // Set canvas size to match the image
            finalCanvas.width = docImage.naturalWidth;
            finalCanvas.height = docImage.naturalHeight;
            
            const finalContext = finalCanvas.getContext('2d');
            
            // Draw the document image
            finalContext.drawImage(docImage, 0, 0, finalCanvas.width, finalCanvas.height);
            
            // Draw all draggable elements in their positions
            document.querySelectorAll('.draggable-resizable').forEach(el => {
                const rect = el.getBoundingClientRect();
                const docRect = document.getElementById('document-content').getBoundingClientRect();
                
                // Calculate position percentage
                const percentX = (rect.left - docRect.left) / docRect.width;
                const percentY = (rect.top - docRect.top) / docRect.height;
                
                // Calculate size percentage
                const percentWidth = rect.width / docRect.width;
                const percentHeight = rect.height / docRect.height;
                
                // Position and size on the final canvas
                const canvasX = percentX * finalCanvas.width;
                const canvasY = percentY * finalCanvas.height;
                const canvasWidth = percentWidth * finalCanvas.width;
                const canvasHeight = percentHeight * finalCanvas.height;
                
                // Draw the element
                const img = el.querySelector('img');
                if (img && img.src) {
                    const tempImg = new Image();
                    tempImg.src = img.src;
                    finalContext.drawImage(tempImg, canvasX, canvasY, canvasWidth, canvasHeight);
                }
            });
            
            // Convert to image and prepare for sharing
            finalCanvas.toBlob(function(blob) {
                if (navigator.share) {
                    const file = new File([blob], `documento-firmado-${activeDocument.name.toLowerCase().replace(/\s/g, '-')}.jpg`, { type: 'image/jpeg' });
                    
                    navigator.share({
                        title: 'Documento Firmado',
                        text: 'Documento con firma digital',
                        files: [file]
                    })
                    .then(() => console.log('Compartido con éxito'))
                    .catch((error) => console.log('Error al compartir:', error))
                    .finally(() => {
                        loadingElement.style.display = 'none';
                    });
                } else {
                    // Fallback for browsers that don't support Web Share API
                    const image = finalCanvas.toDataURL('image/jpeg', 0.95);
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.href = image;
                    downloadLink.download = `documento-firmado-${activeDocument.name.toLowerCase().replace(/\s/g, '-')}.jpg`;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    
                    loadingElement.style.display = 'none';
                    alert('Compartir no está soportado en este navegador. Se ha descargado el documento en su lugar.');
                }
            }, 'image/jpeg', 0.95);
        }, 500);
    });
    
    // Close the drawing modal when clicking outside of it
    window.addEventListener('click', function(e) {
        if (e.target === drawingModal) {
            drawingModal.style.display = 'none';
        }
    });
    
    // Add keyboard event for Escape key to close modal
    window.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && drawingModal.style.display === 'flex') {
            drawingModal.style.display = 'none';
        }
    });
});
    </script>
</body>
</html>
