<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Firma de APCs - Lulo Panamá</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <meta name="robots" content="noindex, nofollow">

    <style>
        /* --- ESTILOS GLOBALES --- */
        :root {
            --primary-color: #133058;
            --secondary-color: #ff5733;
            --text-color: #1a1a1a;
            --background-color: #f0f4f8;
            --border-radius: 24px;
            --transition: all 0.3s ease;
            --gradient-primary: linear-gradient(135deg, #133058 0%, #1e4a77 100%);
            --gradient-secondary: linear-gradient(135deg, #ff5733 0%, #ff7849 100%);
            --liquid-glass: rgba(255, 255, 255, 0.95);
            --liquid-glass-border: rgba(255, 255, 255, 0.6);
            --shadow-medium: 0 12px 40px rgba(19, 48, 88, 0.10);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: "Inter", sans-serif;
            background-color: var(--background-color);
            /* Fondo claro y limpio */
            background-image: 
                radial-gradient(at 10% 10%, rgba(255, 87, 51, 0.05) 0, transparent 50%), 
                radial-gradient(at 90% 90%, rgba(19, 48, 88, 0.05) 0, transparent 50%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-color);
            overflow-x: hidden;
        }

        .app-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 10px;
            position: relative;
            z-index: 10;
        }

        /* --- WIZARD CARD --- */
        .wizard-card {
            background: var(--liquid-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--liquid-glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            width: 100%;
            max-width: 650px;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .wizard-header h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }
        .wizard-header p {
            color: #555;
            margin-bottom: 20px;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        /* --- PROGRESS BAR --- */
        .progress-container {
            width: 100%;
            background: rgba(0,0,0,0.05);
            height: 6px;
            border-radius: 10px;
            margin-bottom: 25px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--gradient-secondary);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* --- STEPS --- */
        .step-content {
            display: none;
            animation: fadeIn 0.4s ease;
            width: 100%;
        }
        .step-content.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DOC GRID --- */
        .doc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
            width: 100%;
            margin-bottom: 20px;
        }
        .doc-btn {
            background: white;
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 15px 5px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            font-weight: 600;
            color: var(--primary-color);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 90px;
            font-size: 0.9rem;
        }
        .doc-btn i { font-size: 1.4rem; color: #cbd5e1; }
        .doc-btn.selected {
            border-color: var(--secondary-color);
            background: #fff5f2;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(255, 87, 51, 0.15);
        }
        .doc-btn.selected i { color: var(--secondary-color); }

        /* --- CANVAS AREAS --- */
        .canvas-wrapper {
            background: white;
            border: 2px dashed #cbd5e1;
            border-radius: 15px;
            width: 100%;
            padding: 10px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            min-height: 160px;
        }

        /* --- FECHA DIVIDIDA --- */
        .date-split-container {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: space-between;
        }
        .date-box {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .date-box label {
            font-size: 0.8rem;
            font-weight: bold;
            color: #666;
        }
        .date-canvas-wrapper {
            background: white;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            height: 100px;
            position: relative;
            overflow: hidden;
        }

        .canvas-wrapper canvas, .date-canvas-wrapper canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
            cursor: crosshair;
        }

        .confirmed {
            border: 2px solid #10b981 !important;
            background: rgba(16, 185, 129, 0.05);
        }

        /* --- BOTONES --- */
        .action-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(19, 48, 88, 0.2);
            width: 100%;
            max-width: 280px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(19, 48, 88, 0.3); }
        .action-btn.secondary {
            background: white;
            color: var(--text-color);
            border: 1px solid #cbd5e1;
            box-shadow: none;
        }
        .action-btn.secondary:hover { background: #f8fafc; border-color: #94a3b8; }
        .action-btn:disabled {
            background: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* --- PREVIEW --- */
        #final-preview-container { max-width: 1000px; padding: 10px; }
        .final-canvas-container {
            width: 100%;
            overflow: auto;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            background: #f8fafc;
            margin-bottom: 20px;
            max-height: 65vh;
        }
        
        .queue-indicator {
            background: rgba(19, 48, 88, 0.1);
            color: var(--primary-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: inline-block;
        }

        .alert-box {
            background-color: #fff8e1;
            border-left: 4px solid #ffd700;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            text-align: left;
            border-radius: 4px;
            color: #555;
        }
        .alert-box strong { color: #333; }

        .footer-links {
            text-align: center;
            padding: 20px;
            color: #475569; /* Gris oscuro para contraste */
            font-size: 0.85rem;
            margin-top: auto;
        }
        .footer-links a {
            color: var(--primary-color);
            text-decoration: none;
            margin: 0 10px;
            font-weight: 600;
            transition: var(--transition);
        }
        .footer-links a:hover { text-decoration: underline; color: var(--secondary-color); }

        .hidden { display: none !important; }

        /* --- MEDIA QUERIES PARA MÓVIL --- */
        @media (max-width: 768px) {
            .wizard-card { 
                padding: 20px; 
                width: 100%; 
                border-radius: 0; 
                min-height: 100vh; 
                display: flex; 
                flex-direction: column; 
                justify-content: center; 
                box-shadow: none;
            }
            .canvas-wrapper { min-height: 280px; }
            .date-split-container { flex-direction: column; gap: 15px; }
            .date-box { width: 100% !important; flex: none !important; }
            .date-canvas-wrapper { height: 120px; }
            .wizard-header h2 { font-size: 1.3rem; }
        }
    </style>
</head>
<body>

    <main class="app-container">
        
        <!-- WIZARD CARD -->
        <div id="wizard-card" class="wizard-card">
            
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>

            <!-- Paso 1: Selección Múltiple -->
            <div id="step-1" class="step-content active">
                <div class="wizard-header">
                    <h2>Selección de Documentos</h2>
                    <p>Selecciona los bancos a firmar (puedes elegir varios).</p>
                </div>
                <div id="document-options" class="doc-grid"></div>
                <button id="step-1-next" class="action-btn" disabled>Continuar <i class="fas fa-arrow-right"></i></button>
            </div>

            <!-- Paso 2: Nombre -->
            <div id="step-2" class="step-content">
                <div class="wizard-header">
                    <h2>Tu Nombre</h2>
                    <p>Escribe tu nombre completo en el recuadro.</p>
                </div>
                <div class="canvas-wrapper">
                    <canvas id="nameCanvasEl" data-logical-width="360" data-logical-height="150"></canvas>
                </div>
                <div class="btn-group">
                    <button class="action-btn secondary" id="clearNameBtn">Borrar</button>
                    <button class="action-btn" id="confirmNameBtn">Confirmar</button>
                </div>
            </div>

            <!-- Paso 3: Cédula -->
            <div id="step-3" class="step-content">
                <div class="wizard-header">
                    <h2>Tu Cédula</h2>
                    <p>Escribe tu número de cédula.</p>
                </div>
                <div class="canvas-wrapper">
                    <canvas id="cedulaCanvasEl" data-logical-width="360" data-logical-height="150"></canvas>
                </div>
                <div class="btn-group">
                    <button class="action-btn secondary" id="clearCedulaBtn">Borrar</button>
                    <button class="action-btn" id="confirmCedulaBtn">Confirmar</button>
                </div>
            </div>

             <!-- Paso 4: Fecha (DIVIDIDA) -->
             <div id="step-4" class="step-content">
                <div class="wizard-header">
                    <h2>La Fecha</h2>
                    <p>Escribe los datos por separado para ajustar el formato "1 de Enero de 2025".</p>
                </div>
                
                <div class="date-split-container">
                    <div class="date-box" style="flex: 0.8;">
                        <label>Día (Ej: 15)</label>
                        <div class="date-canvas-wrapper">
                            <canvas id="dayCanvasEl" data-logical-width="100" data-logical-height="100"></canvas>
                        </div>
                    </div>
                    <div class="date-box" style="flex: 2;">
                        <label>Mes (Ej: Enero)</label>
                        <div class="date-canvas-wrapper">
                            <canvas id="monthCanvasEl" data-logical-width="250" data-logical-height="100"></canvas>
                        </div>
                    </div>
                    <div class="date-box" style="flex: 1.2;">
                        <label>Año (Ej: 2025)</label>
                        <div class="date-canvas-wrapper">
                            <canvas id="yearCanvasEl" data-logical-width="150" data-logical-height="100"></canvas>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="action-btn secondary" id="clearDateBtn">Borrar Todo</button>
                    <button class="action-btn" id="confirmDateBtn">Confirmar</button>
                </div>
            </div>

            <!-- Paso 5: Firma -->
            <div id="step-5" class="step-content">
                <div class="wizard-header">
                    <h2>Tu Firma</h2>
                    <p>Dibuja tu firma tal cual aparece en tu cédula.</p>
                </div>
                <div class="canvas-wrapper">
                    <canvas id="signaturePadEl" data-logical-width="360" data-logical-height="200"></canvas>
                </div>
                <div class="btn-group">
                    <button class="action-btn secondary" id="clearSignatureBtn">Borrar</button>
                    <button class="action-btn" id="confirmSignatureBtn">Finalizar</button>
                </div>
            </div>

        </div>

        <!-- FINAL PREVIEW -->
        <div id="final-preview-card" class="wizard-card hidden" style="max-width: 1000px; height: auto; min-height: auto;">
            <div class="wizard-header">
                <div id="queue-status" class="queue-indicator">Documento 1 de X</div>
                <h2 id="preview-title">Revisando Documento</h2>
                
                <div class="alert-box">
                    <strong> Instrucciones:</strong>
                    <ul style="margin: 5px 0 0 20px; line-height: 1.4;">
                        <li>Arrastra el <strong>Día, Mes y Año</strong> a los espacios vacíos (___ de ___ de ___).</li>
                        <li><strong>¿No hay campo de fecha?</strong> Arrastra la fecha y colócala <strong>debajo de tu cédula</strong>.</li>
                        <li>Usa el cuadrado azul en la esquina de cada elemento para cambiar su tamaño.</li>
                    </ul>
                </div>
            </div>
            
            <div class="final-canvas-container">
                <canvas id="mainDocumentCanvas"></canvas>
            </div>

            <div class="btn-group">
                <button class="action-btn" id="exportDocumentBtn" style="background: var(--gradient-secondary);">
                    <i class="fas fa-download"></i> Descargar
                </button>
                
                <button class="action-btn" id="nextDocBtn" style="background: var(--gradient-primary); display:none;">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
                
                <button class="action-btn secondary" id="finishAllBtn" style="display:none;" onclick="location.reload()">
                    <i class="fas fa-check"></i> Terminar
                </button>
            </div>
        </div>

    </main>

    <footer class="footer-links">
        <a href="https://lulopanama.com/legal/terminos" target="_blank">Términos y Condiciones</a> | 
        <a href="https://lulopanama.com/legal/privacidad" target="_blank">Política de Privacidad</a>
        <br><br>
        &copy; 2024 Lulo Panamá.
    </footer>

    <!-- LÓGICA JAVASCRIPT -->
    <script>
        const dpr = window.devicePixelRatio || 1;
        const RESIZE_HANDLE_LOGICAL_SIZE = 25; 
        const RESIZE_HANDLE_CLICK_EXTENSION = 15;
        const MIN_ELEMENT_DIM = 20;

        const documentConfigurations = [
            { path: "https://lulopanama.com/apc/apc-multi-actual.jpg", shortName: "multi", displayName: "Multibank", icon: "fa-landmark" },
            { path: "https://lulopanama.com/apc/apc-bac-actual.jpg", shortName: "bac", displayName: "BAC", icon: "fa-credit-card" },
            { path: "https://lulopanama.com/apc/apc-banistmo-actual.jpg", shortName: "banistmo", displayName: "Banistmo", icon: "fa-university" },
            { path: "https://lulopanama.com/apc/apc-stgeorge-actual.jpg", shortName: "stgeorge", displayName: "St. George", icon: "fa-shield-alt" },
            { path: "https://lulopanama.com/apc/apc-banesco-actual.jpg", shortName: "banesco", displayName: "Banesco", icon: "fa-coins" },
            { path: "https://lulopanama.com/apc/apc-global-actual.jpg", shortName: "global", displayName: "Global Bank", icon: "fa-globe-americas" }
        ];

        const appState = {
            currentStep: 1, totalSteps: 5, selectedDocsQueue: [], currentQueueIndex: 0, currentDocumentUrl: null,
            nameImageCache: null, cedulaImageCache: null, signatureImageCache: null,
            dayImageCache: null, monthImageCache: null, yearImageCache: null,
            documentSettings: {}, activeElementId: null,
            dragState: { isDragging: false, elementId: null, offsetX: 0, offsetY: 0 },
            resizeState: { isResizing: false, elementId: null, startX: 0, startY: 0, initialElement: {} },
            backgroundImage: null,
            isBlinking: false // Nuevo estado para la animación
        };

        const nameCanvasEl = document.getElementById('nameCanvasEl');
        const cedulaCanvasEl = document.getElementById('cedulaCanvasEl');
        const signaturePadEl = document.getElementById('signaturePadEl');
        const dayCanvasEl = document.getElementById('dayCanvasEl');
        const monthCanvasEl = document.getElementById('monthCanvasEl');
        const yearCanvasEl = document.getElementById('yearCanvasEl');
        const mainCanvas = document.getElementById('mainDocumentCanvas');
        let mainCtx = mainCanvas.getContext('2d');

        let nameCtx, cedulaCtx, sigCtx, dayCtx, monthCtx, yearCtx;

        let drawingStates = {
            name: {isDrawing: false, canvasElement: nameCanvasEl},
            cedula: {isDrawing: false, canvasElement: cedulaCanvasEl},
            signature: {isDrawing: false, canvasElement: signaturePadEl},
            day: {isDrawing: false, canvasElement: dayCanvasEl},
            month: {isDrawing: false, canvasElement: monthCanvasEl},
            year: {isDrawing: false, canvasElement: yearCanvasEl},
        };

        // --- FUNCIONES CORE ---
        function updateProgressBar() {
            const percentage = ((appState.currentStep - 1) / appState.totalSteps) * 100;
            document.getElementById('progress-bar').style.width = percentage + '%';
        }

        function showStep(stepNumber) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            const currentStepEl = document.getElementById(`step-${stepNumber}`);
            
            if(currentStepEl) {
                currentStepEl.classList.add('active');
                appState.currentStep = stepNumber;
                updateProgressBar();

                setTimeout(() => {
                    if(stepNumber === 2) setupDrawingCanvas(nameCanvasEl, 'name');
                    if(stepNumber === 3) setupDrawingCanvas(cedulaCanvasEl, 'cedula');
                    if(stepNumber === 4) {
                        setupDrawingCanvas(dayCanvasEl, 'day');
                        setupDrawingCanvas(monthCanvasEl, 'month');
                        setupDrawingCanvas(yearCanvasEl, 'year');
                    }
                    if(stepNumber === 5) setupDrawingCanvas(signaturePadEl, 'signature');
                }, 150);
            } else if (stepNumber > 5) {
                startReviewProcess();
            }
        }

        function startReviewProcess() {
            document.getElementById('wizard-card').classList.add('hidden');
            document.getElementById('final-preview-card').classList.remove('hidden');
            appState.currentQueueIndex = 0;
            loadNextInQueue();
        }

        function loadNextInQueue() {
            const docConfig = appState.selectedDocsQueue[appState.currentQueueIndex];
            appState.currentDocumentUrl = docConfig.path;
            
            document.getElementById('queue-status').textContent = `Documento ${appState.currentQueueIndex + 1} de ${appState.selectedDocsQueue.length}`;
            document.getElementById('preview-title').textContent = `${docConfig.displayName}`;
            
            const nextBtn = document.getElementById('nextDocBtn');
            const finishBtn = document.getElementById('finishAllBtn');
            const downloadBtn = document.getElementById('exportDocumentBtn');
            
            downloadBtn.innerHTML = `<i class="fas fa-download"></i> Descargar`;
            downloadBtn.style.opacity = "1";
            
            if (appState.currentQueueIndex < appState.selectedDocsQueue.length - 1) {
                nextBtn.style.display = 'inline-flex';
                finishBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'inline-flex';
            }

            loadDocumentImage(docConfig.path);
        }

        document.getElementById('nextDocBtn').addEventListener('click', () => {
            appState.currentQueueIndex++;
            loadNextInQueue();
        });

        // --- DRAWING ENGINE ---
        function configureDrawingContext(ctx, width, height, clear = true) {
            ctx.resetTransform();
            ctx.scale(dpr, dpr);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3; 
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            if (clear) ctx.clearRect(0, 0, width, height);
        }

        function setupDrawingCanvas(canvasEl, stateKey) {
            const parent = canvasEl.parentElement;
            const rect = parent.getBoundingClientRect();
            const logicalWidth = rect.width;
            
            let logicalHeight = parseInt(canvasEl.dataset.logicalHeight) || 150;
            if(window.innerWidth < 768 && stateKey !== 'day' && stateKey !== 'year') {
                if (stateKey === 'month') logicalHeight = 120;
                else logicalHeight = 250; 
            }

            canvasEl.style.width = '100%';
            canvasEl.style.height = logicalHeight + 'px';
            canvasEl.width = logicalWidth * dpr;
            canvasEl.height = logicalHeight * dpr;

            const ctx = canvasEl.getContext('2d');
            configureDrawingContext(ctx, logicalWidth, logicalHeight);

            if (!canvasEl.dataset.listenersAttached) {
                const opts = { passive: false };
                const start = (e) => startDrawing(e, ctx, stateKey);
                const move = (e) => draw(e, ctx, stateKey);
                const stop = () => stopDrawing(stateKey);
                canvasEl.addEventListener('mousedown', start);
                canvasEl.addEventListener('mousemove', move);
                canvasEl.addEventListener('mouseup', stop);
                canvasEl.addEventListener('mouseleave', stop);
                canvasEl.addEventListener('touchstart', start, opts);
                canvasEl.addEventListener('touchmove', move, opts);
                canvasEl.addEventListener('touchend', stop);
                canvasEl.dataset.listenersAttached = 'true';
            }
            drawingStates[stateKey].canvasElement = canvasEl;
            
            if(stateKey === 'name') nameCtx = ctx;
            if(stateKey === 'cedula') cedulaCtx = ctx;
            if(stateKey === 'signature') sigCtx = ctx;
            if(stateKey === 'day') dayCtx = ctx;
            if(stateKey === 'month') monthCtx = ctx;
            if(stateKey === 'year') yearCtx = ctx;

            return ctx;
        }

        function getPadCoordinates(canvasEl, event) {
            const rect = canvasEl.getBoundingClientRect();
            let clientX, clientY;
            if (event.touches && event.touches.length > 0) {
                clientX = event.touches[0].clientX; clientY = event.touches[0].clientY;
            } else if (event.clientX !== undefined) {
                clientX = event.clientX; clientY = event.clientY;
            } else { return null; }
            return {
                x: (clientX - rect.left) * (canvasEl.width / dpr / rect.width),
                y: (clientY - rect.top) * (canvasEl.height / dpr / rect.height)
            };
        }

        function startDrawing(e, ctx, stateKey) {
            const padState = drawingStates[stateKey];
            padState.isDrawing = true;
            const coords = getPadCoordinates(padState.canvasElement, e);
            if (!coords) return;
            ctx.beginPath(); ctx.moveTo(coords.x, coords.y);
            if(e.cancelable) e.preventDefault();
        }

        function draw(e, ctx, stateKey) {
            const padState = drawingStates[stateKey];
            if (!padState.isDrawing) return;
            const coords = getPadCoordinates(padState.canvasElement, e);
            if (!coords) return;
            ctx.lineTo(coords.x, coords.y); ctx.stroke();
            if(e.cancelable) e.preventDefault();
        }

        function stopDrawing(stateKey) { drawingStates[stateKey].isDrawing = false; }
        
        function clearPad(ctx, canvasEl) {
            if(!ctx) return;
            const w = canvasEl.width / dpr; const h = canvasEl.height / dpr;
            ctx.clearRect(0,0,w,h); ctx.beginPath();
            canvasEl.parentElement.classList.remove('confirmed');
        }

        function confirmStep(ctx, imageCacheKey, canvasEl) {
            const tempImage = new Image();
            tempImage.onload = () => {
                appState[imageCacheKey] = tempImage;
                canvasEl.parentElement.classList.add('confirmed');
                setTimeout(() => { showStep(appState.currentStep + 1); }, 300);
            }
            tempImage.src = ctx.canvas.toDataURL('image/png');
        }

        function confirmDateStep() {
            let loaded = 0;
            const checkNext = () => {
                loaded++;
                if(loaded === 3) {
                    dayCanvasEl.parentElement.classList.add('confirmed');
                    monthCanvasEl.parentElement.classList.add('confirmed');
                    yearCanvasEl.parentElement.classList.add('confirmed');
                    setTimeout(() => { showStep(appState.currentStep + 1); }, 300);
                }
            };
            const imgDay = new Image(); imgDay.onload = () => { appState.dayImageCache = imgDay; checkNext(); };
            imgDay.src = dayCtx.canvas.toDataURL('image/png');
            const imgMonth = new Image(); imgMonth.onload = () => { appState.monthImageCache = imgMonth; checkNext(); };
            imgMonth.src = monthCtx.canvas.toDataURL('image/png');
            const imgYear = new Image(); imgYear.onload = () => { appState.yearImageCache = imgYear; checkNext(); };
            imgYear.src = yearCtx.canvas.toDataURL('image/png');
        }
        
        function clearDateStep() {
            clearPad(dayCtx, dayCanvasEl); clearPad(monthCtx, monthCanvasEl); clearPad(yearCtx, yearCanvasEl);
        }

        function initDocumentGrid() {
            const container = document.getElementById('document-options');
            const nextBtn = document.getElementById('step-1-next');
            
            // 1. Manejo de Parámetros URL (?d=bac,banesco)
            const params = new URLSearchParams(window.location.search);
            const dParam = params.get('d'); // devuelve "bac,banesco"
            const preselectedCodes = dParam ? dParam.split(',').map(s => s.trim().toLowerCase()) : [];

            documentConfigurations.forEach(doc => {
                const btn = document.createElement('div');
                btn.className = 'doc-btn';
                btn.innerHTML = `<i class="fas ${doc.icon || 'fa-file-alt'}"></i><span>${doc.displayName}</span>`;
                
                // Función toggle
                btn.onclick = () => {
                    const index = appState.selectedDocsQueue.findIndex(d => d.path === doc.path);
                    if (index === -1) { appState.selectedDocsQueue.push(doc); btn.classList.add('selected'); } 
                    else { appState.selectedDocsQueue.splice(index, 1); btn.classList.remove('selected'); }
                    nextBtn.disabled = appState.selectedDocsQueue.length === 0;
                };

                // Preselección automática
                if(preselectedCodes.includes(doc.shortName.toLowerCase())) {
                    appState.selectedDocsQueue.push(doc);
                    btn.classList.add('selected');
                }

                container.appendChild(btn);
            });

            // Si hay documentos preseleccionados, habilitar el botón
            if(appState.selectedDocsQueue.length > 0) {
                nextBtn.disabled = false;
            }

            nextBtn.onclick = () => showStep(2);
        }

        function initializeDefaultDocumentSettings() {
            const elW = 180; const elH = 45;
            const sigW = 190; const sigH = 70;
            const dayW = 40; const monthW = 100; const yearW = 50;
            
            documentConfigurations.forEach(docConfig => {
                if (!appState.documentSettings[docConfig.path]) {
                    appState.documentSettings[docConfig.path] = {
                        elements: [
                            { id: 'name', type: 'image', x: 50, y: 50, width: elW, height: elH },
                            { id: 'cedula', type: 'image', x: 50, y: 105, width: elW, height: elH },
                            { id: 'day', type: 'image', x: 50, y: 160, width: dayW, height: 35 },
                            { id: 'month', type: 'image', x: 100, y: 160, width: monthW, height: 35 },
                            { id: 'year', type: 'image', x: 210, y: 160, width: yearW, height: 35 },
                            { id: 'signature', type: 'image', x: 50, y: 220, width: sigW, height: sigH }
                        ]};
                }});
        }

        function loadDocumentImage(docUrl) {
            appState.backgroundImage = new Image();
            appState.backgroundImage.crossOrigin = "anonymous";
            appState.activeElementId = null;

            const container = mainCanvas.parentElement;
            const logicalWidth = container.clientWidth || 300;
            const logicalHeight = logicalWidth * 1.3;
            
            mainCanvas.style.width = logicalWidth + 'px';
            mainCanvas.style.height = logicalHeight + 'px';
            mainCanvas.width = logicalWidth * dpr;
            mainCanvas.height = logicalHeight * dpr;
            configureDrawingContext(mainCtx, logicalWidth, logicalHeight);
            mainCtx.fillText("Cargando...", logicalWidth/2, logicalHeight/2);

            appState.backgroundImage.onload = () => {
                const imageAspectRatio = appState.backgroundImage.naturalWidth / appState.backgroundImage.naturalHeight;
                let displayWidth = container.clientWidth;
                let displayHeight = displayWidth / imageAspectRatio;
                mainCanvas.style.width = displayWidth + 'px';
                mainCanvas.style.height = displayHeight + 'px';
                mainCanvas.width = displayWidth * dpr;
                mainCanvas.height = displayHeight * dpr;
                configureDrawingContext(mainCtx, displayWidth, displayHeight, false);
                mainCtx.imageSmoothingEnabled = true;
                
                // --- INICIO ANIMACIÓN PARPADEO ---
                appState.isBlinking = true;
                redrawMainCanvas();
                
                setTimeout(() => {
                    appState.isBlinking = false;
                    redrawMainCanvas();
                }, 1500); // 1.5 segundos de parpadeo
            };
            appState.backgroundImage.src = docUrl;
        }

        function redrawMainCanvas(isExporting = false) {
            if (!mainCtx || !appState.backgroundImage) return;
            const logicalWidth = mainCanvas.width / dpr;
            const logicalHeight = mainCanvas.height / dpr;
            mainCtx.clearRect(0, 0, logicalWidth, logicalHeight);
            mainCtx.drawImage(appState.backgroundImage, 0, 0, logicalWidth, logicalHeight);

            const settings = appState.documentSettings[appState.currentDocumentUrl];
            if (!settings) return;

            settings.elements.forEach(element => {
                let imgKey = null;
                if(element.id === 'name') imgKey = 'nameImageCache';
                else if(element.id === 'cedula') imgKey = 'cedulaImageCache';
                else if(element.id === 'signature') imgKey = 'signatureImageCache';
                else if(element.id === 'day') imgKey = 'dayImageCache';
                else if(element.id === 'month') imgKey = 'monthImageCache';
                else if(element.id === 'year') imgKey = 'yearImageCache';

                const imageToDraw = appState[imgKey];
                if (imageToDraw) {
                    mainCtx.drawImage(imageToDraw, element.x, element.y, element.width, element.height);
                    
                    // Lógica para dibujar bordes (Selección O Animación)
                    const showBorder = (appState.activeElementId === element.id && !isExporting) || (appState.isBlinking && !isExporting);
                    
                    if (showBorder) {
                        mainCtx.strokeStyle = '#ff5733'; // Naranja Lulo
                        mainCtx.lineWidth = 2;
                        mainCtx.strokeRect(element.x, element.y, element.width, element.height);
                        
                        // Handle solo si está seleccionado (no durante parpadeo general)
                        if (appState.activeElementId === element.id) {
                            const handleSize = RESIZE_HANDLE_LOGICAL_SIZE;
                            mainCtx.fillStyle = '#ff5733';
                            mainCtx.fillRect(element.x + element.width - handleSize/2, element.y + element.height - handleSize/2, handleSize, handleSize);
                        }
                    }
                }
            });
        }

        function getElementById(docUrl, elementId) { return appState.documentSettings[docUrl].elements.find(el => el.id === elementId); }
        function isPointInElement(x, y, el) { return x >= el.x && x <= el.x + el.width && y >= el.y && y <= el.y + el.height; }
        function isPointInResizeHandle(x, y, el) {
            const padding = RESIZE_HANDLE_CLICK_EXTENSION;
            const right = el.x + el.width; const bottom = el.y + el.height;
            return x >= right - padding && x <= right + padding + 15 && y >= bottom - padding && y <= bottom + padding + 15;
        }
        function getCanvasCoords(e) {
            const rect = mainCanvas.getBoundingClientRect();
            let cx, cy;
            if(e.touches && e.touches.length > 0) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; } else { cx = e.clientX; cy = e.clientY; }
            const scaleX = mainCanvas.width / dpr / rect.width;
            const scaleY = mainCanvas.height / dpr / rect.height;
            return { x: (cx - rect.left) * scaleX, y: (cy - rect.top) * scaleY };
        }

        function handleMainStart(e) {
            if(e.cancelable) e.preventDefault();
            const coords = getCanvasCoords(e);
            const settings = appState.documentSettings[appState.currentDocumentUrl];
            if(!settings) return;

            let clickedResize = false; let foundId = null;
            if(appState.activeElementId) {
                const activeEl = getElementById(appState.currentDocumentUrl, appState.activeElementId);
                if(isPointInResizeHandle(coords.x, coords.y, activeEl)) { clickedResize = true; foundId = appState.activeElementId; }
            }
            if(!clickedResize) {
                for(let i = settings.elements.length - 1; i >= 0; i--) {
                    if(isPointInElement(coords.x, coords.y, settings.elements[i])) { foundId = settings.elements[i].id; break; }
                }
            }
            appState.activeElementId = foundId;
            if(foundId) {
                const el = getElementById(appState.currentDocumentUrl, foundId);
                if(clickedResize) {
                    appState.resizeState = { isResizing: true, elementId: foundId, startX: coords.x, initialElement: { ...el, aspectRatio: el.width / el.height } };
                } else {
                    appState.dragState = { isDragging: true, elementId: foundId, offsetX: coords.x - el.x, offsetY: coords.y - el.y };
                }
            }
            redrawMainCanvas();
        }

        function handleMainMove(e) {
            if(e.cancelable) e.preventDefault();
            const coords = getCanvasCoords(e);
            if(appState.resizeState.isResizing) {
                const el = getElementById(appState.currentDocumentUrl, appState.resizeState.elementId);
                const dx = coords.x - appState.resizeState.startX;
                const initial = appState.resizeState.initialElement;
                let newW = Math.max(MIN_ELEMENT_DIM, initial.width + dx);
                let newH = newW / initial.aspectRatio;
                el.width = newW; el.height = newH;
                redrawMainCanvas();
            } else if(appState.dragState.isDragging) {
                const el = getElementById(appState.currentDocumentUrl, appState.dragState.elementId);
                el.x = coords.x - appState.dragState.offsetX;
                el.y = coords.y - appState.dragState.offsetY;
                redrawMainCanvas();
            }
        }

        function handleMainEnd() { appState.resizeState.isResizing = false; appState.dragState.isDragging = false; }

        document.getElementById('exportDocumentBtn').addEventListener('click', function() {
            const savedId = appState.activeElementId;
            appState.activeElementId = null; 
            redrawMainCanvas(true);
            const link = document.createElement('a');
            const currentDocName = appState.selectedDocsQueue[appState.currentQueueIndex].shortName;
            link.download = `APC_${currentDocName}_Firmado.jpg`;
            link.href = mainCanvas.toDataURL('image/jpeg', 0.9);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            appState.activeElementId = savedId;
            redrawMainCanvas();
            this.innerHTML = `<i class="fas fa-check"></i> Descargado`;
            this.style.opacity = "0.7";
        });

        window.onload = function() {
            initDocumentGrid();
            initializeDefaultDocumentSettings();

            document.getElementById('confirmNameBtn').onclick = () => confirmStep(nameCtx, 'nameImageCache', nameCanvasEl);
            document.getElementById('clearNameBtn').onclick = () => clearPad(nameCtx, nameCanvasEl);

            document.getElementById('confirmCedulaBtn').onclick = () => confirmStep(cedulaCtx, 'cedulaImageCache', cedulaCanvasEl);
            document.getElementById('clearCedulaBtn').onclick = () => clearPad(cedulaCtx, cedulaCanvasEl);

            document.getElementById('confirmDateBtn').onclick = confirmDateStep;
            document.getElementById('clearDateBtn').onclick = clearDateStep;

            document.getElementById('confirmSignatureBtn').onclick = () => confirmStep(sigCtx, 'signatureImageCache', signaturePadEl);
            document.getElementById('clearSignatureBtn').onclick = () => clearPad(sigCtx, signaturePadEl);

            const opts = { passive: false };
            mainCanvas.addEventListener('mousedown', handleMainStart);
            mainCanvas.addEventListener('mousemove', handleMainMove);
            mainCanvas.addEventListener('mouseup', handleMainEnd);
            mainCanvas.addEventListener('touchstart', handleMainStart, opts);
            mainCanvas.addEventListener('touchmove', handleMainMove, opts);
            mainCanvas.addEventListener('touchend', handleMainEnd);
        };
    </script>
</body>
</html>
