<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Firma de APCs - Lulo Panamá</title>
    
    <!-- META TAGS -->
    <meta name="description" content="Herramienta digital para firmar documentos APC.">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Favicon -->
    <link rel="icon" href="https://cdn.lulopanama.com/favicon.png" type="image/png">

    <!-- Social Previews -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Firma de APCs - Lulo Panamá">
    <meta property="og:image" content="https://cdn.lulopanama.com/lulo-firma-banner.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://cdn.lulopanama.com/lulo-firma-banner.jpg">

    <!-- Fuentes e Iconos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <meta name="robots" content="noindex, nofollow">

    <style>
        /* --- ESTILOS APP NATIVA --- */
        :root {
            --primary-color: #133058;
            --secondary-color: #ff5733;
            --bg-color: #ffffff;
            --input-bg: #f3f4f6;
            --border-color: #e5e7eb;
            --text-color: #111827;
            --subtext-color: #6b7280;
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: "Inter", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-container {
            flex: 1;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        /* --- HEADER & PROGRESS --- */
        .app-header {
            margin-bottom: 25px;
            text-align: center;
            padding-top: 10px;
        }
        
        .progress-bar-bg {
            width: 100%;
            height: 6px;
            background: #f3f4f6;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #2563eb);
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Cambio de Logo solicitado */
        h2 { 
            font-family: 'Montserrat', sans-serif; 
            font-weight: 400; 
            letter-spacing: -0.75px;
            font-size: 1.8rem; /* Ajustado ligeramente para el nuevo font */
            color: var(--primary-color); 
            margin-bottom: 8px; 
        }
        
        p { color: var(--subtext-color); line-height: 1.5; font-size: 0.95rem; }

        /* --- STEPS --- */
        .step-content { display: none; width: 100%; animation: fadeUp 0.3s ease; }
        .step-content.active { display: flex; flex-direction: column; gap: 20px; }
        
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- INPUTS / CANVAS --- */
        .canvas-label {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: var(--text-color);
        }

        .canvas-wrapper {
            background: var(--input-bg);
            border: 2px dashed #d1d5db;
            border-radius: var(--radius);
            width: 100%;
            position: relative;
            overflow: hidden;
            min-height: 180px;
            transition: border-color 0.3s;
        }

        .canvas-wrapper.confirmed {
            border: 2px solid #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        .check-icon {
            position: absolute; top: 10px; right: 10px;
            background: #10b981; color: white;
            width: 24px; height: 24px; border-radius: 50%;
            display: none; align-items: center; justify-content: center;
            font-size: 12px; pointer-events: none;
        }
        .canvas-wrapper.confirmed .check-icon { display: flex; }

        canvas { width: 100%; height: 100%; touch-action: none; cursor: crosshair; }

        /* --- DATE SPLIT (MODIFICADO VERTICALMENTE) --- */
        .date-split-row { 
            display: flex; 
            flex-direction: column; /* Alineación vertical */
            gap: 20px; 
        }
        .date-col { 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
        }
        .date-canvas-sm { 
            height: 110px; 
            min-height: 110px; 
        }

        /* --- DOC GRID --- */
        .doc-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .doc-btn {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .doc-btn i { font-size: 1.5rem; color: #9ca3af; }
        .doc-btn span { font-weight: 600; font-size: 0.9rem; }
        
        .doc-btn.selected {
            border-color: var(--secondary-color);
            background: #fff5f0;
            box-shadow: 0 4px 12px rgba(255, 87, 51, 0.15);
        }
        .doc-btn.selected i { color: var(--secondary-color); }

        /* --- BUTTONS --- */
        .btn-container {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap; /* Para que se ajusten si es necesario */
            gap: 12px;
            justify-content: center;
        }
        
        .btn {
            padding: 14px 24px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s;
            flex: 1;
            min-width: 140px; /* Ancho mínimo para que no se aplasten */
            max-width: 300px;
        }
        .btn:active { transform: scale(0.98); }
        
        .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(19,48,88,0.2); }
        .btn-secondary { background: white; color: var(--text-color); border: 1px solid #d1d5db; }
        .btn-download { background: var(--secondary-color); color: white; box-shadow: 0 4px 10px rgba(255,87,51,0.3); }
        .btn:disabled { background: #e5e7eb; color: #9ca3af; box-shadow: none; pointer-events: none; }

        /* --- PREVIEW SECTION --- */
        .preview-canvas-container {
            width: 100%;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: var(--radius);
            overflow: auto;
            max-height: 60vh;
            margin-bottom: 20px;
            /* IMPORTANTE: Altura mínima para asegurar que se vea */
            min-height: 300px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .instruction-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            color: #1e3a8a;
            text-align: left;
        }

        /* --- COMPLETION SCREEN --- */
        #completion-view {
            text-align: center;
            padding: 40px 20px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .success-icon {
            width: 80px; height: 80px;
            background: #ecfdf5; color: #10b981;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; margin: 0 auto 20px;
            animation: bounce 1s infinite;
        }

        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* --- FOOTER --- */
        footer {
            margin-top: auto;
            text-align: center;
            padding: 30px 20px;
            font-size: 0.8rem;
            color: #6b7280;
            border-top: 1px solid #f3f4f6;
        }
        footer a { color: var(--primary-color); text-decoration: none; font-weight: 600; }

        .hidden { display: none !important; }

        @media (min-width: 768px) {
            .doc-grid { grid-template-columns: repeat(3, 1fr); }
            body { background-color: #f9fafb; }
            .app-container { background: white; margin-top: 20px; margin-bottom: 20px; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- HEADER & PROGRESS -->
        <div class="app-header" id="app-header">
            <h2>lulo</h2>
            <div class="progress-bar-bg">
                <div id="progress-bar" class="progress-bar-fill"></div>
            </div>
        </div>

        <!-- --- PASOS --- -->

        <!-- Paso 1: Selección -->
        <div id="step-1" class="step-content active">
            <div style="text-align:center; margin-bottom:10px;">
                <p>Selecciona los bancos a firmar hoy:</p>
            </div>
            <div id="document-options" class="doc-grid"></div>
            <div class="btn-container">
                <button id="step-1-next" class="btn btn-primary" disabled>
                    Continuar <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Paso 2: Nombre -->
        <div id="step-2" class="step-content">
            <div style="text-align:center;"><p>Escribe tu <strong>Nombre Completo</strong>:</p></div>
            <div class="canvas-wrapper">
                <div class="check-icon"><i class="fas fa-check"></i></div>
                <canvas id="nameCanvasEl" data-logical-width="360" data-logical-height="150"></canvas>
            </div>
            <div class="btn-container">
                <button class="btn btn-secondary" id="clearNameBtn">Borrar</button>
                <button class="btn btn-primary" id="confirmNameBtn">Confirmar</button>
            </div>
        </div>

        <!-- Paso 3: Cédula -->
        <div id="step-3" class="step-content">
            <div style="text-align:center;"><p>Escribe tu <strong>Cédula</strong>:</p></div>
            <div class="canvas-wrapper">
                <div class="check-icon"><i class="fas fa-check"></i></div>
                <canvas id="cedulaCanvasEl" data-logical-width="360" data-logical-height="150"></canvas>
            </div>
            <div class="btn-container">
                <button class="btn btn-secondary" id="clearCedulaBtn">Borrar</button>
                <button class="btn btn-primary" id="confirmCedulaBtn">Confirmar</button>
            </div>
        </div>

         <!-- Paso 4: Fecha Dividida -->
         <div id="step-4" class="step-content">
            <div style="text-align:center; margin-bottom:10px;">
                <p>Escribe la fecha por separado para ajustarla:</p>
            </div>
            
            <div class="date-split-row">
                <!-- Se cambió a 360 el logical width para que ocupen todo el ancho y se vea bien -->
                <div class="date-col">
                    <span class="canvas-label">Día</span>
                    <div class="canvas-wrapper date-canvas-sm">
                        <div class="check-icon"><i class="fas fa-check"></i></div>
                        <canvas id="dayCanvasEl" data-logical-width="360" data-logical-height="100"></canvas>
                    </div>
                </div>
                <div class="date-col">
                    <span class="canvas-label">Mes</span>
                    <div class="canvas-wrapper date-canvas-sm">
                        <div class="check-icon"><i class="fas fa-check"></i></div>
                        <canvas id="monthCanvasEl" data-logical-width="360" data-logical-height="100"></canvas>
                    </div>
                </div>
                <div class="date-col">
                    <span class="canvas-label">Año</span>
                    <div class="canvas-wrapper date-canvas-sm">
                        <div class="check-icon"><i class="fas fa-check"></i></div>
                        <canvas id="yearCanvasEl" data-logical-width="360" data-logical-height="100"></canvas>
                    </div>
                </div>
            </div>

            <div class="btn-container">
                <button class="btn btn-secondary" id="clearDateBtn">Borrar</button>
                <button class="btn btn-primary" id="confirmDateBtn">Confirmar</button>
            </div>
        </div>

        <!-- Paso 5: Firma -->
        <div id="step-5" class="step-content">
            <div style="text-align:center;"><p>Dibuja tu <strong>Firma</strong> (igual a la cédula):</p></div>
            <div class="canvas-wrapper" style="min-height:220px;">
                <div class="check-icon"><i class="fas fa-check"></i></div>
                <canvas id="signaturePadEl" data-logical-width="360" data-logical-height="200"></canvas>
            </div>
            <div class="btn-container">
                <button class="btn btn-secondary" id="clearSignatureBtn">Borrar</button>
                <button class="btn btn-primary" id="confirmSignatureBtn">Finalizar</button>
            </div>
        </div>

        <!-- VISTA DE REVISIÓN Y DESCARGA -->
        <div id="final-preview-view" class="step-content hidden">
            <div style="text-align:center; margin-bottom:15px;">
                <span id="queue-status" style="background:#e0f2fe; color:#0369a1; padding:4px 12px; border-radius:12px; font-size:0.8rem; font-weight:600;">Doc 1/1</span>
                <h3 id="preview-title" style="margin-top:10px; color:var(--text-color);">Revisando...</h3>
            </div>

            <div class="instruction-box">
                <i class="fas fa-info-circle"></i> <strong>Instrucciones:</strong>
                <ul style="margin: 5px 0 0 20px;">
                    <li>Arrastra <strong>Día, Mes y Año</strong> a sus líneas.</li>
                    <li>Si no hay fecha, ponla <strong>debajo de la cédula</strong>.</li>
                    <li>Usa el cuadro azul en la esquina para cambiar tamaño.</li>
                </ul>
            </div>
            
            <div class="preview-canvas-container">
                <canvas id="mainDocumentCanvas"></canvas>
            </div>

            <!-- Botones alineados juntos -->
            <div class="btn-container">
                <button class="btn btn-download" id="exportDocumentBtn">
                    <i class="fas fa-download"></i> Descargar Documento
                </button>

                <button class="btn btn-primary" id="nextDocBtn" style="display:none;">
                    Siguiente Documento <i class="fas fa-arrow-right"></i>
                </button>
                
                <button class="btn btn-secondary" id="finishAllBtn" style="display:none;">
                    Terminar Proceso
                </button>
            </div>
        </div>

        <!-- PANTALLA DE COMPLETADO -->
        <div id="completion-view" class="hidden">
            <div class="success-icon">
                <i class="fas fa-check"></i>
            </div>
            <h2>¡Proceso Terminado!</h2>
            <p style="font-size:1rem; margin-bottom:30px;">
                Has firmado todos los documentos correctamente. <br><br>
                <strong>Por favor, envíale los documentos firmados a tu asesor asignado por WhatsApp.</strong>
            </p>
            <button class="btn btn-primary" onclick="location.reload()">
                <i class="fas fa-redo"></i> Empezar otra vez
            </button>
        </div>

        <footer>
            <a href="https://lulopanama.com/legal/terminos" target="_blank">Términos</a> | 
            <a href="https://lulopanama.com/legal/privacidad" target="_blank">Privacidad</a>
            <br><br>
            &copy; <span id="year"></span> Lulo Panamá.
        </footer>

    </div>

    <!-- JAVASCRIPT -->
    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        const dpr = window.devicePixelRatio || 1;
        const RESIZE_HANDLE_SIZE = 25; 
        const MIN_ELEMENT_DIM = 20;

        const documentConfigurations = [
            { path: "https://lulopanama.com/apc/apc-multi-actual.jpg", shortName: "multi", displayName: "Multibank", icon: "fa-landmark" },
            { path: "https://lulopanama.com/apc/apc-bac-actual.jpg", shortName: "bac", displayName: "BAC", icon: "fa-landmark" },
            { path: "https://lulopanama.com/apc/apc-banistmo-actual.jpg", shortName: "banistmo", displayName: "Banistmo", icon: "fa-landmark" },
            { path: "https://lulopanama.com/apc/apc-stgeorge-actual.jpg", shortName: "stgeorge", displayName: "St. George", icon: "fa-landmark" },
            { path: "https://lulopanama.com/apc/apc-banesco-actual.jpg", shortName: "banesco", displayName: "Banesco", icon: "fa-landmark" },
            { path: "https://lulopanama.com/apc/apc-global-actual.jpg", shortName: "global", displayName: "Global Bank", icon: "fa-landmark" }
        ];

        const appState = {
            currentStep: 1, totalSteps: 5, selectedDocsQueue: [], currentQueueIndex: 0, currentDocumentUrl: null,
            nameImageCache: null, cedulaImageCache: null, signatureImageCache: null,
            dayImageCache: null, monthImageCache: null, yearImageCache: null,
            documentSettings: {}, activeElementId: null,
            dragState: { isDragging: false, elementId: null, offsetX: 0, offsetY: 0 },
            resizeState: { isResizing: false, elementId: null, startX: 0, startY: 0, initialElement: {} },
            backgroundImage: null, isBlinking: false
        };

        const nameCanvasEl = document.getElementById('nameCanvasEl');
        const cedulaCanvasEl = document.getElementById('cedulaCanvasEl');
        const signaturePadEl = document.getElementById('signaturePadEl');
        const dayCanvasEl = document.getElementById('dayCanvasEl');
        const monthCanvasEl = document.getElementById('monthCanvasEl');
        const yearCanvasEl = document.getElementById('yearCanvasEl');
        const mainCanvas = document.getElementById('mainDocumentCanvas');
        let mainCtx = mainCanvas.getContext('2d');

        let nameCtx, cedulaCtx, sigCtx, dayCtx, monthCtx, yearCtx;

        let drawingStates = {
            name: {isDrawing: false, canvasElement: nameCanvasEl},
            cedula: {isDrawing: false, canvasElement: cedulaCanvasEl},
            signature: {isDrawing: false, canvasElement: signaturePadEl},
            day: {isDrawing: false, canvasElement: dayCanvasEl},
            month: {isDrawing: false, canvasElement: monthCanvasEl},
            year: {isDrawing: false, canvasElement: yearCanvasEl},
        };

        // --- NAVEGACIÓN ---
        function updateProgressBar() {
            const percentage = ((appState.currentStep - 1) / appState.totalSteps) * 100;
            document.getElementById('progress-bar').style.width = percentage + '%';
        }

        function showStep(stepNumber) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            const currentStepEl = document.getElementById(`step-${stepNumber}`);
            
            if(currentStepEl) {
                currentStepEl.classList.add('active');
                appState.currentStep = stepNumber;
                updateProgressBar();
                // Inicializar Canvas con delay
                setTimeout(() => {
                    if(stepNumber === 2) setupDrawingCanvas(nameCanvasEl, 'name');
                    if(stepNumber === 3) setupDrawingCanvas(cedulaCanvasEl, 'cedula');
                    if(stepNumber === 4) {
                        setupDrawingCanvas(dayCanvasEl, 'day');
                        setupDrawingCanvas(monthCanvasEl, 'month');
                        setupDrawingCanvas(yearCanvasEl, 'year');
                    }
                    if(stepNumber === 5) setupDrawingCanvas(signaturePadEl, 'signature');
                }, 100);
            } else if (stepNumber > 5) {
                startReviewProcess();
            }
        }

        function startReviewProcess() {
            // Eliminar header y mostrar preview
            document.getElementById('app-header').style.display = 'none';
            
            // CORRECCIÓN CRÍTICA: Remover hidden y añadir active
            const previewEl = document.getElementById('final-preview-view');
            previewEl.classList.remove('hidden');
            previewEl.classList.add('active');

            appState.currentQueueIndex = 0;
            loadNextInQueue();
        }

        function finishProcess() {
            // Ocultar preview y mostrar completado
            const previewEl = document.getElementById('final-preview-view');
            previewEl.classList.remove('active');
            previewEl.classList.add('hidden'); // Asegurar que se oculte

            const completionEl = document.getElementById('completion-view');
            completionEl.classList.remove('hidden');
        }

        function loadNextInQueue() {
            const docConfig = appState.selectedDocsQueue[appState.currentQueueIndex];
            appState.currentDocumentUrl = docConfig.path;
            
            document.getElementById('queue-status').textContent = `Documento ${appState.currentQueueIndex + 1} de ${appState.selectedDocsQueue.length}`;
            document.getElementById('preview-title').textContent = `${docConfig.displayName}`;
            
            const nextBtn = document.getElementById('nextDocBtn');
            const finishBtn = document.getElementById('finishAllBtn');
            const downloadBtn = document.getElementById('exportDocumentBtn');
            
            downloadBtn.innerHTML = `<i class="fas fa-download"></i> Descargar Documento`;
            downloadBtn.style.opacity = "1";
            downloadBtn.style.pointerEvents = "auto";
            
            if (appState.currentQueueIndex < appState.selectedDocsQueue.length - 1) {
                nextBtn.style.display = 'inline-flex';
                finishBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'inline-flex';
            }

            loadDocumentImage(docConfig.path);
        }

        document.getElementById('nextDocBtn').addEventListener('click', () => {
            appState.currentQueueIndex++;
            loadNextInQueue();
        });

        document.getElementById('finishAllBtn').addEventListener('click', finishProcess);

        // --- CANVAS LOGIC ---
        function configureDrawingContext(ctx, width, height, clear = true) {
            ctx.resetTransform();
            ctx.scale(dpr, dpr);
            ctx.strokeStyle = '#111827';
            ctx.lineWidth = 3; 
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            if (clear) ctx.clearRect(0, 0, width, height);
        }

        function setupDrawingCanvas(canvasEl, stateKey) {
            const parent = canvasEl.parentElement;
            const rect = parent.getBoundingClientRect();
            const logicalWidth = rect.width;
            let logicalHeight = parseInt(canvasEl.dataset.logicalHeight) || 150;
            
            if(window.innerWidth < 768 && stateKey !== 'day' && stateKey !== 'year' && stateKey !== 'month') {
                logicalHeight = 220; 
            }

            canvasEl.style.width = '100%';
            canvasEl.style.height = logicalHeight + 'px';
            canvasEl.width = logicalWidth * dpr;
            canvasEl.height = logicalHeight * dpr;

            const ctx = canvasEl.getContext('2d');
            configureDrawingContext(ctx, logicalWidth, logicalHeight);

            if (!canvasEl.dataset.listenersAttached) {
                const opts = { passive: false };
                const start = (e) => startDrawing(e, ctx, stateKey);
                const move = (e) => draw(e, ctx, stateKey);
                const stop = () => stopDrawing(stateKey);
                canvasEl.addEventListener('mousedown', start);
                canvasEl.addEventListener('mousemove', move);
                canvasEl.addEventListener('mouseup', stop);
                canvasEl.addEventListener('mouseleave', stop);
                canvasEl.addEventListener('touchstart', start, opts);
                canvasEl.addEventListener('touchmove', move, opts);
                canvasEl.addEventListener('touchend', stop);
                canvasEl.dataset.listenersAttached = 'true';
            }
            drawingStates[stateKey].canvasElement = canvasEl;
            
            if(stateKey === 'name') nameCtx = ctx;
            if(stateKey === 'cedula') cedulaCtx = ctx;
            if(stateKey === 'signature') sigCtx = ctx;
            if(stateKey === 'day') dayCtx = ctx;
            if(stateKey === 'month') monthCtx = ctx;
            if(stateKey === 'year') yearCtx = ctx;

            return ctx;
        }

        function getPadCoordinates(canvasEl, event) {
            const rect = canvasEl.getBoundingClientRect();
            let clientX, clientY;
            if (event.touches && event.touches.length > 0) {
                clientX = event.touches[0].clientX; clientY = event.touches[0].clientY;
            } else if (event.clientX !== undefined) {
                clientX = event.clientX; clientY = event.clientY;
            } else { return null; }
            return {
                x: (clientX - rect.left) * (canvasEl.width / dpr / rect.width),
                y: (clientY - rect.top) * (canvasEl.height / dpr / rect.height)
            };
        }

        function startDrawing(e, ctx, stateKey) {
            const padState = drawingStates[stateKey];
            padState.isDrawing = true;
            const coords = getPadCoordinates(padState.canvasElement, e);
            if (!coords) return;
            ctx.beginPath(); ctx.moveTo(coords.x, coords.y);
            if(e.cancelable) e.preventDefault();
        }

        function draw(e, ctx, stateKey) {
            const padState = drawingStates[stateKey];
            if (!padState.isDrawing) return;
            const coords = getPadCoordinates(padState.canvasElement, e);
            if (!coords) return;
            ctx.lineTo(coords.x, coords.y); ctx.stroke();
            if(e.cancelable) e.preventDefault();
        }

        function stopDrawing(stateKey) { drawingStates[stateKey].isDrawing = false; }
        
        function clearPad(ctx, canvasEl) {
            if(!ctx) return;
            const w = canvasEl.width / dpr; const h = canvasEl.height / dpr;
            ctx.clearRect(0,0,w,h); ctx.beginPath();
            canvasEl.parentElement.classList.remove('confirmed');
        }

        function confirmStep(ctx, imageCacheKey, canvasEl) {
            const tempImage = new Image();
            tempImage.onload = () => {
                appState[imageCacheKey] = tempImage;
                canvasEl.parentElement.classList.add('confirmed');
                setTimeout(() => { showStep(appState.currentStep + 1); }, 400);
            }
            tempImage.src = ctx.canvas.toDataURL('image/png');
        }

        function confirmDateStep() {
            let loaded = 0;
            const checkNext = () => {
                loaded++;
                if(loaded === 3) {
                    dayCanvasEl.parentElement.classList.add('confirmed');
                    monthCanvasEl.parentElement.classList.add('confirmed');
                    yearCanvasEl.parentElement.classList.add('confirmed');
                    setTimeout(() => { showStep(appState.currentStep + 1); }, 400);
                }
            };
            const imgDay = new Image(); imgDay.onload = () => { appState.dayImageCache = imgDay; checkNext(); };
            imgDay.src = dayCtx.canvas.toDataURL('image/png');
            const imgMonth = new Image(); imgMonth.onload = () => { appState.monthImageCache = imgMonth; checkNext(); };
            imgMonth.src = monthCtx.canvas.toDataURL('image/png');
            const imgYear = new Image(); imgYear.onload = () => { appState.yearImageCache = imgYear; checkNext(); };
            imgYear.src = yearCtx.canvas.toDataURL('image/png');
        }
        
        function clearDateStep() {
            clearPad(dayCtx, dayCanvasEl); clearPad(monthCtx, monthCanvasEl); clearPad(yearCtx, yearCanvasEl);
        }

        // --- INIT & LOGIC ---

        function initDocumentGrid() {
            const container = document.getElementById('document-options');
            const nextBtn = document.getElementById('step-1-next');
            
            const params = new URLSearchParams(window.location.search);
            const dParam = params.get('d');
            const preselectedCodes = dParam ? dParam.split(',').map(s => s.trim().toLowerCase()) : [];

            documentConfigurations.forEach(doc => {
                const btn = document.createElement('div');
                btn.className = 'doc-btn';
                btn.innerHTML = `<i class="fas ${doc.icon || 'fa-file-alt'}"></i><span>${doc.displayName}</span>`;
                btn.onclick = () => {
                    const index = appState.selectedDocsQueue.findIndex(d => d.path === doc.path);
                    if (index === -1) { appState.selectedDocsQueue.push(doc); btn.classList.add('selected'); } 
                    else { appState.selectedDocsQueue.splice(index, 1); btn.classList.remove('selected'); }
                    nextBtn.disabled = appState.selectedDocsQueue.length === 0;
                };
                if(preselectedCodes.includes(doc.shortName.toLowerCase())) {
                    appState.selectedDocsQueue.push(doc);
                    btn.classList.add('selected');
                }
                container.appendChild(btn);
            });
            if(appState.selectedDocsQueue.length > 0) nextBtn.disabled = false;
            nextBtn.onclick = () => showStep(2);
        }

        function initializeDefaultDocumentSettings() {
            const elW = 180; const elH = 45; const sigW = 190; const sigH = 70;
            const dayW = 40; const monthW = 100; const yearW = 50;
            
            documentConfigurations.forEach(docConfig => {
                if (!appState.documentSettings[docConfig.path]) {
                    appState.documentSettings[docConfig.path] = {
                        elements: [
                            { id: 'name', type: 'image', x: 50, y: 50, width: elW, height: elH },
                            { id: 'cedula', type: 'image', x: 50, y: 105, width: elW, height: elH },
                            { id: 'day', type: 'image', x: 50, y: 160, width: dayW, height: 35 },
                            { id: 'month', type: 'image', x: 100, y: 160, width: monthW, height: 35 },
                            { id: 'year', type: 'image', x: 210, y: 160, width: yearW, height: 35 },
                            { id: 'signature', type: 'image', x: 50, y: 220, width: sigW, height: sigH }
                        ]};
                }});
        }

        function loadDocumentImage(docUrl) {
            appState.backgroundImage = new Image();
            appState.backgroundImage.crossOrigin = "anonymous";
            appState.activeElementId = null;

            const container = mainCanvas.parentElement;
            const logicalWidth = container.clientWidth || 300;
            const logicalHeight = logicalWidth * 1.3;
            
            mainCanvas.style.width = logicalWidth + 'px';
            mainCanvas.style.height = logicalHeight + 'px';
            mainCanvas.width = logicalWidth * dpr;
            mainCanvas.height = logicalHeight * dpr;
            configureDrawingContext(mainCtx, logicalWidth, logicalHeight);
            mainCtx.fillStyle = "#9ca3af";
            mainCtx.font = "16px Inter";
            mainCtx.textAlign = "center";
            mainCtx.fillText("Cargando documento...", logicalWidth/2, logicalHeight/2);

            appState.backgroundImage.onload = () => {
                const imageAspectRatio = appState.backgroundImage.naturalWidth / appState.backgroundImage.naturalHeight;
                let displayWidth = container.clientWidth;
                let displayHeight = displayWidth / imageAspectRatio;
                mainCanvas.style.width = displayWidth + 'px';
                mainCanvas.style.height = displayHeight + 'px';
                mainCanvas.width = displayWidth * dpr;
                mainCanvas.height = displayHeight * dpr;
                configureDrawingContext(mainCtx, displayWidth, displayHeight, false);
                mainCtx.imageSmoothingEnabled = true;
                
                appState.isBlinking = true;
                redrawMainCanvas();
                setTimeout(() => { appState.isBlinking = false; redrawMainCanvas(); }, 1500);
            };
            appState.backgroundImage.onerror = () => {
                alert("Error cargando la imagen. Intenta recargar la página.");
            };
            appState.backgroundImage.src = docUrl;
        }

        function redrawMainCanvas(isExporting = false) {
            if (!mainCtx || !appState.backgroundImage) return;
            const logicalWidth = mainCanvas.width / dpr;
            const logicalHeight = mainCanvas.height / dpr;
            mainCtx.clearRect(0, 0, logicalWidth, logicalHeight);
            mainCtx.drawImage(appState.backgroundImage, 0, 0, logicalWidth, logicalHeight);

            const settings = appState.documentSettings[appState.currentDocumentUrl];
            if (!settings) return;

            settings.elements.forEach(element => {
                let imgKey = null;
                if(element.id === 'name') imgKey = 'nameImageCache';
                else if(element.id === 'cedula') imgKey = 'cedulaImageCache';
                else if(element.id === 'signature') imgKey = 'signatureImageCache';
                else if(element.id === 'day') imgKey = 'dayImageCache';
                else if(element.id === 'month') imgKey = 'monthImageCache';
                else if(element.id === 'year') imgKey = 'yearImageCache';

                const imageToDraw = appState[imgKey];
                if (imageToDraw) {
                    mainCtx.drawImage(imageToDraw, element.x, element.y, element.width, element.height);
                    const showBorder = (appState.activeElementId === element.id && !isExporting) || (appState.isBlinking && !isExporting);
                    if (showBorder) {
                        mainCtx.strokeStyle = '#ff5733'; mainCtx.lineWidth = 2;
                        mainCtx.strokeRect(element.x, element.y, element.width, element.height);
                        if (appState.activeElementId === element.id) {
                            const handleSize = RESIZE_HANDLE_SIZE;
                            mainCtx.fillStyle = '#ff5733';
                            mainCtx.fillRect(element.x + element.width - handleSize/2, element.y + element.height - handleSize/2, handleSize, handleSize);
                        }
                    }
                }
            });
        }

        function getElementById(docUrl, elementId) { return appState.documentSettings[docUrl].elements.find(el => el.id === elementId); }
        function isPointInElement(x, y, el) { return x >= el.x && x <= el.x + el.width && y >= el.y && y <= el.y + el.height; }
        function isPointInResizeHandle(x, y, el) {
            const padding = 15;
            const right = el.x + el.width; const bottom = el.y + el.height;
            return x >= right - padding && x <= right + padding + 15 && y >= bottom - padding && y <= bottom + padding + 15;
        }
        function getCanvasCoords(e) {
            const rect = mainCanvas.getBoundingClientRect();
            let cx, cy;
            if(e.touches && e.touches.length > 0) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; } else { cx = e.clientX; cy = e.clientY; }
            const scaleX = mainCanvas.width / dpr / rect.width;
            const scaleY = mainCanvas.height / dpr / rect.height;
            return { x: (cx - rect.left) * scaleX, y: (cy - rect.top) * scaleY };
        }

        function handleMainStart(e) {
            if(e.cancelable) e.preventDefault();
            const coords = getCanvasCoords(e);
            const settings = appState.documentSettings[appState.currentDocumentUrl];
            if(!settings) return;
            let clickedResize = false; let foundId = null;
            if(appState.activeElementId) {
                const activeEl = getElementById(appState.currentDocumentUrl, appState.activeElementId);
                if(isPointInResizeHandle(coords.x, coords.y, activeEl)) { clickedResize = true; foundId = appState.activeElementId; }
            }
            if(!clickedResize) {
                for(let i = settings.elements.length - 1; i >= 0; i--) {
                    if(isPointInElement(coords.x, coords.y, settings.elements[i])) { foundId = settings.elements[i].id; break; }
                }
            }
            appState.activeElementId = foundId;
            if(foundId) {
                const el = getElementById(appState.currentDocumentUrl, foundId);
                if(clickedResize) {
                    appState.resizeState = { isResizing: true, elementId: foundId, startX: coords.x, initialElement: { ...el, aspectRatio: el.width / el.height } };
                } else {
                    appState.dragState = { isDragging: true, elementId: foundId, offsetX: coords.x - el.x, offsetY: coords.y - el.y };
                }
            }
            redrawMainCanvas();
        }

        function handleMainMove(e) {
            if(e.cancelable) e.preventDefault();
            const coords = getCanvasCoords(e);
            if(appState.resizeState.isResizing) {
                const el = getElementById(appState.currentDocumentUrl, appState.resizeState.elementId);
                const dx = coords.x - appState.resizeState.startX;
                const initial = appState.resizeState.initialElement;
                let newW = Math.max(MIN_ELEMENT_DIM, initial.width + dx);
                let newH = newW / initial.aspectRatio;
                el.width = newW; el.height = newH;
                redrawMainCanvas();
            } else if(appState.dragState.isDragging) {
                const el = getElementById(appState.currentDocumentUrl, appState.dragState.elementId);
                el.x = coords.x - appState.dragState.offsetX;
                el.y = coords.y - appState.dragState.offsetY;
                redrawMainCanvas();
            }
        }

        function handleMainEnd() { appState.resizeState.isResizing = false; appState.dragState.isDragging = false; }

        document.getElementById('exportDocumentBtn').addEventListener('click', function() {
            const savedId = appState.activeElementId;
            appState.activeElementId = null; 
            redrawMainCanvas(true);
            
            const link = document.createElement('a');
            const currentDocShort = appState.selectedDocsQueue[appState.currentQueueIndex].shortName;
            
            // NOMBRE DE ARCHIVO: bac-12345-firmado.jpg
            const randomNum = Math.floor(Math.random() * 90000) + 10000;
            link.download = `${currentDocShort}-${randomNum}-firmado.jpg`;
            
            link.href = mainCanvas.toDataURL('image/jpeg', 0.9);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            appState.activeElementId = savedId;
            redrawMainCanvas();
            this.innerHTML = `<i class="fas fa-check"></i> Descargado`;
            this.style.opacity = "0.7";
            this.style.pointerEvents = "none";
        });

        window.onload = function() {
            initDocumentGrid();
            initializeDefaultDocumentSettings();

            document.getElementById('confirmNameBtn').onclick = () => confirmStep(nameCtx, 'nameImageCache', nameCanvasEl);
            document.getElementById('clearNameBtn').onclick = () => clearPad(nameCtx, nameCanvasEl);
            document.getElementById('confirmCedulaBtn').onclick = () => confirmStep(cedulaCtx, 'cedulaImageCache', cedulaCanvasEl);
            document.getElementById('clearCedulaBtn').onclick = () => clearPad(cedulaCtx, cedulaCanvasEl);
            document.getElementById('confirmDateBtn').onclick = confirmDateStep;
            document.getElementById('clearDateBtn').onclick = clearDateStep;
            document.getElementById('confirmSignatureBtn').onclick = () => confirmStep(sigCtx, 'signatureImageCache', signaturePadEl);
            document.getElementById('clearSignatureBtn').onclick = () => clearPad(sigCtx, signaturePadEl);

            const opts = { passive: false };
            mainCanvas.addEventListener('mousedown', handleMainStart);
            mainCanvas.addEventListener('mousemove', handleMainMove);
            mainCanvas.addEventListener('mouseup', handleMainEnd);
            mainCanvas.addEventListener('touchstart', handleMainStart, opts);
            mainCanvas.addEventListener('touchmove', handleMainMove, opts);
            mainCanvas.addEventListener('touchend', handleMainEnd);
        };
    </script>
</body>
</html>
