<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Firma de APCs - Lulo Panamá</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <meta name="robots" content="noindex, nofollow">

    <style>
        /* --- TUS ESTILOS PROPORCIONADOS --- */
        :root {
            --primary-color: #133058;
            --secondary-color: #ff5733;
            --accent-color: #ffd700;
            --text-color: #1a1a1a;
            --light-text: #fff;
            --background-color: #fafbfc;
            --card-background: #ffffff;
            --border-radius: 24px; /* Ajustado para móviles */
            --transition: all 0.3s ease;
            --gradient-primary: linear-gradient(135deg, #133058 0%, #1e4a77 100%);
            --gradient-secondary: linear-gradient(135deg, #ff5733 0%, #ff7849 100%);
            --gradient-accent: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.25);
            --liquid-glass: rgba(255, 255, 255, 0.85); /* Más opaco para legibilidad */
            --liquid-glass-border: rgba(255, 255, 255, 0.5);
            --liquid-glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-medium: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: "Inter", sans-serif;
            background: var(--background-color);
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-color);
            overflow-x: hidden;
        }

        /* Header Style */
        .header-container {
            width: 95%;
            max-width: 1200px;
            margin: 20px auto 0;
            border-radius: 50px;
            padding: 15px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid var(--liquid-glass-border);
            box-shadow: var(--liquid-glass-shadow);
            position: relative;
            z-index: 100;
        }

        .logo {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
        }

        /* Christmas Lights */
        .christmas-lights-container {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            height: 40px;
            z-index: -1;
            pointer-events: none;
            display: flex;
            justify-content: center;
            padding: 0 40px; 
            margin-top: -6px; 
        }
        .christmas-lights-container li {
            list-style: none; flex: 1; min-width: 50px; max-width: 70px; height: 20px;
            border-bottom: 2px solid #222; border-radius: 50%; position: relative; margin: 0 -10px;
            animation: swing 3s infinite ease-in-out;
        }
        .christmas-lights-container li::before {
            content: ''; position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%);
            width: 12px; height: 12px; border-radius: 50%; background: #fff;
            animation: glow 3s infinite alternate;
        }
        .christmas-lights-container li::after {
            content: ''; position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%);
            width: 8px; height: 6px; background: #222; border-radius: 2px;
        }
        .christmas-lights-container li:nth-child(4n+1)::before { background-color: #ff0033; box-shadow: 0 2px 10px 2px rgba(255, 0, 51, 0.5); }
        .christmas-lights-container li:nth-child(4n+2)::before { background-color: #abff00; box-shadow: 0 2px 10px 2px rgba(171, 255, 0, 0.5); animation-delay: 0.5s; }
        .christmas-lights-container li:nth-child(4n+3)::before { background-color: #00ffbf; box-shadow: 0 2px 10px 2px rgba(0, 255, 191, 0.5); animation-delay: 1s; }
        .christmas-lights-container li:nth-child(4n+4)::before { background-color: #ccff00; box-shadow: 0 2px 10px 2px rgba(204, 255, 0, 0.5); animation-delay: 1.5s; }
        @keyframes swing { 0%, 100% { transform: rotate(-2deg); } 50% { transform: rotate(2deg); } }
        @keyframes glow { 0% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Main App Container */
        .app-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            position: relative;
            z-index: 10;
        }

        /* Wizard Card (The Modal) */
        .wizard-card {
            background: var(--liquid-glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--liquid-glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            width: 100%;
            max-width: 600px;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .wizard-header h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .wizard-header p {
            color: #666;
            margin-bottom: 30px;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background: rgba(0,0,0,0.1);
            height: 6px;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--gradient-secondary);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* Steps Logic */
        .step-content {
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease;
        }
        .step-content.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Document Selection Grid */
        .doc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            width: 100%;
        }
        .doc-btn {
            background: white;
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 20px 10px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            font-weight: 600;
            color: var(--primary-color);
            transition: var(--transition);
        }
        .doc-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .doc-btn.selected {
            border-color: var(--secondary-color);
            background: #fff5f2;
            transform: scale(1.05);
        }

        /* Canvas Areas inside Wizard */
        .canvas-wrapper {
            background: white;
            border: 2px dashed #ccc;
            border-radius: 15px;
            width: 100%;
            padding: 10px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
            overflow: hidden;
        }
        .canvas-wrapper canvas {
            max-width: 100%;
            cursor: crosshair;
            touch-action: none;
        }
        .canvas-wrapper.confirmed {
            border: 2px solid #10b981;
            background: rgba(16, 185, 129, 0.05);
        }
        .canvas-wrapper.confirmed::after {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #10b981;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Buttons */
        .action-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(19, 48, 88, 0.3);
            width: 100%;
            max-width: 300px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(19, 48, 88, 0.4);
        }
        .action-btn.secondary {
            background: white;
            color: var(--text-color);
            border: 1px solid #ccc;
        }
        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }

        /* Final Preview Canvas */
        #final-preview-container {
            /* This one needs to be big */
            max-width: 1000px;
            padding: 20px;
        }
        .final-canvas-container {
            width: 100%;
            overflow: auto;
            border-radius: 8px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            background: #eee;
            margin-bottom: 20px;
            max-height: 70vh;
        }
        #mainDocumentCanvas {
            display: block;
            margin: 0 auto;
            background: white;
        }

        /* Helpers */
        .helper-text {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .wizard-card { padding: 25px; width: 95%; }
            .header-container { width: 90%; flex-direction: column; gap: 10px; }
            .logo { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <!-- Header con Luces -->
    <header class="header-container">
        <a href="#" class="logo">Lulo <span style="color:var(--secondary-color)">Panamá</span></a>
        <ul class="christmas-lights-container">
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
        </ul>
    </header>

    <main class="app-container">
        
        <!-- WIZARD CARD -->
        <div id="wizard-card" class="wizard-card">
            
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>

            <!-- Paso 1: Selección de Documento -->
            <div id="step-1" class="step-content active">
                <div class="wizard-header">
                    <h2>Vamos a empezar</h2>
                    <p>¿Qué documento necesitas firmar hoy?</p>
                </div>
                <div id="document-options" class="doc-grid">
                    <!-- Botones generados por JS -->
                </div>
                <!-- El botón de siguiente aparece cuando se selecciona uno -->
                <button id="step-1-next" class="action-btn" disabled>Continuar <i class="fas fa-arrow-right"></i></button>
            </div>

            <!-- Paso 2: Nombre -->
            <div id="step-2" class="step-content">
                <div class="wizard-header">
                    <h2>Escribe tu Nombre</h2>
                    <p>Usa tu dedo o mouse para escribir tu nombre completo.</p>
                </div>
                <div class="canvas-wrapper">
                    <canvas id="nameCanvasEl" data-logical-width="360" data-logical-height="100"></canvas>
                </div>
                <div class="btn-group">
                    <button class="action-btn secondary" id="clearNameBtn">Borrar</button>
                    <button class="action-btn" id="confirmNameBtn">Confirmar y Seguir</button>
                </div>
            </div>

            <!-- Paso 3: Cédula -->
            <div id="step-3" class="step-content">
                <div class="wizard-header">
                    <h2>Tu Cédula</h2>
                    <p>Escribe tu número de cédula manuscrito.</p>
                </div>
                <div class="canvas-wrapper">
                    <canvas id="cedulaCanvasEl" data-logical-width="360" data-logical-height="100"></canvas>
                </div>
                <div class="btn-group">
                    <button class="action-btn secondary" id="clearCedulaBtn">Borrar</button>
                    <button class="action-btn" id="confirmCedulaBtn">Confirmar y Seguir</button>
                </div>
            </div>

             <!-- Paso 4: Fecha -->
             <div id="step-4" class="step-content">
                <div class="wizard-header">
                    <h2>La Fecha</h2>
                    <p>Escribe la fecha de hoy.</p>
                </div>
                <div class="canvas-wrapper">
                    <canvas id="dateCanvasEl" data-logical-width="360" data-logical-height="80"></canvas>
                </div>
                <div class="btn-group">
                    <button class="action-btn secondary" id="clearDateBtn">Borrar</button>
                    <button class="action-btn" id="confirmDateBtn">Confirmar y Seguir</button>
                </div>
            </div>

            <!-- Paso 5: Firma -->
            <div id="step-5" class="step-content">
                <div class="wizard-header">
                    <h2>Tu Firma</h2>
                    <p>Dibuja tu firma tal cual aparece en tu cédula.</p>
                </div>
                <div class="canvas-wrapper">
                    <canvas id="signaturePadEl" data-logical-width="360" data-logical-height="120"></canvas>
                </div>
                <div class="btn-group">
                    <button class="action-btn secondary" id="clearSignatureBtn">Borrar</button>
                    <button class="action-btn" id="confirmSignatureBtn">Finalizar</button>
                </div>
            </div>

        </div>

        <!-- FINAL PREVIEW (Hidden initially, replaces wizard) -->
        <div id="final-preview-card" class="wizard-card hidden" style="max-width: 1000px;">
            <div class="wizard-header">
                <h2>¡Todo Listo!</h2>
                <p>Arrastra tus datos a la posición correcta sobre el documento. Si necesitas cambiar el tamaño, selecciona el elemento y arrastra la esquina.</p>
            </div>
            
            <div class="final-canvas-container">
                <canvas id="mainDocumentCanvas"></canvas>
            </div>

            <div class="btn-group">
                <button class="action-btn secondary" onclick="location.reload()">Empezar de nuevo</button>
                <button class="action-btn" id="exportDocumentBtn" style="background: var(--gradient-secondary);">
                    Descargar Documento Firmado
                </button>
            </div>
             <!-- Hidden controls for resizing logic compatibility -->
            <div id="elementSizingControls" style="display:none;">
                <input type="number" id="elementWidth">
                <input type="number" id="elementHeight">
            </div>
        </div>

    </main>

    <footer style="text-align:center; padding: 20px; color: #666; font-size: 0.8rem;">
        &copy; 2024 Lulo Panamá. Todos los derechos reservados.
    </footer>

    <!-- LÓGICA JAVASCRIPT -->
    <script>
        // --- CONSTANTES Y CONFIGURACIÓN ---
        const dpr = window.devicePixelRatio || 1;
        const RESIZE_HANDLE_LOGICAL_SIZE = 15; // Un poco más grande para dedo
        const RESIZE_HANDLE_CLICK_EXTENSION = 10;
        const MIN_ELEMENT_DIM = 20;

        const documentConfigurations = [
            { path: "https://lulopanama.com/apc/apc-multi-actual.jpg", shortName: "multi", displayName: "Multibank" },
            { path: "https://lulopanama.com/apc/apc-bac-actual.jpg", shortName: "bac", displayName: "BAC Credomatic" },
            { path: "https://lulopanama.com/apc/apc-banistmo-actual.jpg", shortName: "banistmo", displayName: "Banistmo" },
            { path: "https://lulopanama.com/apc/apc-stgeorge-actual.jpg", shortName: "stgeorge", displayName: "St. George" },
            { path: "https://lulopanama.com/apc/apc-banesco-actual.jpg", shortName: "banesco", displayName: "Banesco" },
            { path: "https://lulopanama.com/apc/apc-global-actual.jpg", shortName: "global", displayName: "Global Bank" }
        ];

        // --- ESTADO DE LA APLICACIÓN ---
        const appState = {
            currentStep: 1,
            totalSteps: 5,
            currentDocumentUrl: null,
            nameImageCache: null, cedulaImageCache: null, dateImageCache: null, signatureImageCache: null,
            documentSettings: {}, 
            activeElementId: null,
            dragState: { isDragging: false, elementId: null, offsetX: 0, offsetY: 0 },
            resizeState: {
                isResizing: false, elementId: null,
                startX: 0, startY: 0,
                initialElement: { x:0, y:0, width: 0, height: 0, aspectRatio: 1 }
            },
            backgroundImage: null,
            resizeTimeout: null
        };

        // --- REFERENCIAS DOM ---
        const wizardCard = document.getElementById('wizard-card');
        const finalPreviewCard = document.getElementById('final-preview-card');
        const progressBar = document.getElementById('progress-bar');
        
        // Canvas Elements
        const nameCanvasEl = document.getElementById('nameCanvasEl');
        const cedulaCanvasEl = document.getElementById('cedulaCanvasEl');
        const dateCanvasEl = document.getElementById('dateCanvasEl');
        const signaturePadEl = document.getElementById('signaturePadEl');
        const mainCanvas = document.getElementById('mainDocumentCanvas');
        let mainCtx = mainCanvas.getContext('2d');

        // Contextos
        let nameCtx, cedulaCtx, dateCtx, sigCtx;

        let drawingStates = {
            name: {isDrawing: false, lastX:0, lastY:0, canvasElement: nameCanvasEl},
            cedula: {isDrawing: false, lastX:0, lastY:0, canvasElement: cedulaCanvasEl},
            date: {isDrawing: false, lastX:0, lastY:0, canvasElement: dateCanvasEl},
            signature: {isDrawing: false, lastX:0, lastY:0, canvasElement: signaturePadEl}
        };

        // --- LÓGICA DE NAVEGACIÓN (WIZARD) ---

        function updateProgressBar() {
            const percentage = ((appState.currentStep - 1) / appState.totalSteps) * 100;
            progressBar.style.width = percentage + '%';
        }

        function showStep(stepNumber) {
            // Ocultar todos los pasos
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            
            // Mostrar paso actual
            const currentStepEl = document.getElementById(`step-${stepNumber}`);
            if(currentStepEl) {
                currentStepEl.classList.add('active');
                appState.currentStep = stepNumber;
                updateProgressBar();

                // Inicializar Canvas específico si es un paso de dibujo
                // Usamos setTimeout para asegurar que el div ya es visible y tiene ancho
                setTimeout(() => {
                    if(stepNumber === 2) setupDrawingCanvas(nameCanvasEl, 'name');
                    if(stepNumber === 3) setupDrawingCanvas(cedulaCanvasEl, 'cedula');
                    if(stepNumber === 4) setupDrawingCanvas(dateCanvasEl, 'date');
                    if(stepNumber === 5) setupDrawingCanvas(signaturePadEl, 'signature');
                }, 100);
            } else if (stepNumber > 5) {
                // Fin del wizard, mostrar preview
                showFinalPreview();
            }
        }

        function showFinalPreview() {
            wizardCard.classList.add('hidden');
            finalPreviewCard.classList.remove('hidden');
            loadDocument(appState.currentDocumentUrl); // Cargar documento y elementos
        }

        // --- LÓGICA DE DIBUJO (CORE PRESERVADO) ---

        function configureDrawingContext(ctx, width, height, clear = true) {
            ctx.resetTransform();
            ctx.scale(dpr, dpr);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3; // Ligeramente más grueso para verse mejor
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            if (clear) ctx.clearRect(0, 0, width, height);
        }

        function setupDrawingCanvas(canvasEl, stateKey) {
            const parent = canvasEl.parentElement;
            const rect = parent.getBoundingClientRect();
            
            // Lógica de tamaño
            const logicalWidth = rect.width; // Usar el ancho del contenedor padre
            const logicalHeight = parseInt(canvasEl.dataset.logicalHeight) || 100;
            
            // Evitar redimensionar si ya está configurado correctamente y es visible
            // Pero como es un wizard, forzamos reajuste para asegurar.
            
            canvasEl.style.width = '100%';
            canvasEl.style.height = logicalHeight + 'px';
            canvasEl.width = logicalWidth * dpr;
            canvasEl.height = logicalHeight * dpr;

            const ctx = canvasEl.getContext('2d');
            configureDrawingContext(ctx, logicalWidth, logicalHeight);

            // Listeners (Solo adjuntar una vez)
            if (!canvasEl.dataset.listenersAttached) {
                const opts = { passive: false };
                const start = (e) => startDrawing(e, ctx, stateKey);
                const move = (e) => draw(e, ctx, stateKey);
                const stop = () => stopDrawing(stateKey);

                canvasEl.addEventListener('mousedown', start);
                canvasEl.addEventListener('mousemove', move);
                canvasEl.addEventListener('mouseup', stop);
                canvasEl.addEventListener('mouseleave', stop);
                
                canvasEl.addEventListener('touchstart', start, opts);
                canvasEl.addEventListener('touchmove', move, opts);
                canvasEl.addEventListener('touchend', stop);
                
                canvasEl.dataset.listenersAttached = 'true';
            }
            drawingStates[stateKey].canvasElement = canvasEl;
            
            // Guardar referencia global del contexto
            if(stateKey === 'name') nameCtx = ctx;
            if(stateKey === 'cedula') cedulaCtx = ctx;
            if(stateKey === 'date') dateCtx = ctx;
            if(stateKey === 'signature') sigCtx = ctx;

            return ctx;
        }

        function getPadCoordinates(canvasEl, event) {
            const rect = canvasEl.getBoundingClientRect();
            let clientX, clientY;
            if (event.touches && event.touches.length > 0) {
                clientX = event.touches[0].clientX; clientY = event.touches[0].clientY;
            } else if (event.clientX !== undefined) {
                clientX = event.clientX; clientY = event.clientY;
            } else { return null; }

            return {
                x: (clientX - rect.left) * (canvasEl.width / dpr / rect.width),
                y: (clientY - rect.top) * (canvasEl.height / dpr / rect.height)
            };
        }

        function startDrawing(e, ctx, stateKey) {
            const padState = drawingStates[stateKey];
            padState.isDrawing = true;
            const coords = getPadCoordinates(padState.canvasElement, e);
            if (!coords) return;
            ctx.beginPath(); ctx.moveTo(coords.x, coords.y);
            padState.lastX = coords.x; padState.lastY = coords.y;
            if(e.cancelable) e.preventDefault();
        }

        function draw(e, ctx, stateKey) {
            const padState = drawingStates[stateKey];
            if (!padState.isDrawing) return;
            const coords = getPadCoordinates(padState.canvasElement, e);
            if (!coords) return;
            ctx.lineTo(coords.x, coords.y); ctx.stroke();
            padState.lastX = coords.x; padState.lastY = coords.y;
            if(e.cancelable) e.preventDefault();
        }

        function stopDrawing(stateKey) {
            drawingStates[stateKey].isDrawing = false;
        }

        function clearPad(ctx, canvasEl, stateKey) {
            if(!ctx) return;
            const w = canvasEl.width / dpr;
            const h = canvasEl.height / dpr;
            ctx.clearRect(0,0,w,h);
            ctx.beginPath();
            canvasEl.parentElement.classList.remove('confirmed');
        }

        function confirmStep(ctx, imageCacheKey, canvasEl) {
            // Guardar imagen en memoria
            const tempImage = new Image();
            tempImage.onload = () => {
                appState[imageCacheKey] = tempImage;
                canvasEl.parentElement.classList.add('confirmed');
                // Avanzar paso después de breve delay visual
                setTimeout(() => {
                    showStep(appState.currentStep + 1);
                }, 300);
            }
            tempImage.src = ctx.canvas.toDataURL('image/png');
        }


        // --- CARGA DE DOCUMENTO Y CANVAS FINAL ---

        function initDocumentGrid() {
            const container = document.getElementById('document-options');
            const nextBtn = document.getElementById('step-1-next');
            
            documentConfigurations.forEach(doc => {
                const btn = document.createElement('div');
                btn.className = 'doc-btn';
                btn.textContent = doc.displayName;
                btn.onclick = () => {
                    // Remover clase selected de otros
                    document.querySelectorAll('.doc-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    appState.currentDocumentUrl = doc.path;
                    nextBtn.disabled = false;
                };
                container.appendChild(btn);
            });

            nextBtn.onclick = () => showStep(2);
        }

        function initializeDefaultDocumentSettings() {
            const defaultElementWidth = 180; const defaultElementHeight = 45;
            const defaultDateHeight = 35; const defaultSigWidth = 190; const defaultSigHeight = 70;
            documentConfigurations.forEach(docConfig => {
                const docPath = docConfig.path;
                if (!appState.documentSettings[docPath]) {
                    appState.documentSettings[docPath] = {
                        elements: [
                            { id: 'name', type: 'image', x: 50, y: 50, width: defaultElementWidth, height: defaultElementHeight },
                            { id: 'cedula', type: 'image', x: 50, y: 105, width: defaultElementWidth, height: defaultElementHeight },
                            { id: 'date', type: 'image', x: 50, y: 160, width: defaultElementWidth * 0.8, height: defaultDateHeight },
                            { id: 'signature', type: 'image', x: 50, y: 205, width: defaultSigWidth, height: defaultSigHeight }
                        ]};
                }});
        }

        function loadDocument(docUrl) {
            appState.backgroundImage = new Image();
            appState.backgroundImage.crossOrigin = "anonymous"; // Importante para exportar
            
            // Texto de carga
            const logicalWidth = mainCanvas.parentElement.clientWidth || 300;
            const logicalHeight = logicalWidth * 1.3; // Ratio aprox
            mainCanvas.style.width = logicalWidth + 'px';
            mainCanvas.style.height = logicalHeight + 'px';
            mainCanvas.width = logicalWidth * dpr;
            mainCanvas.height = logicalHeight * dpr;
            configureDrawingContext(mainCtx, logicalWidth, logicalHeight);
            mainCtx.fillText("Cargando documento...", logicalWidth/2, logicalHeight/2);

            appState.backgroundImage.onload = () => {
                const container = mainCanvas.parentElement;
                const imageAspectRatio = appState.backgroundImage.naturalWidth / appState.backgroundImage.naturalHeight;
                
                let displayWidth = container.clientWidth;
                let displayHeight = displayWidth / imageAspectRatio;

                mainCanvas.style.width = displayWidth + 'px';
                mainCanvas.style.height = displayHeight + 'px';
                mainCanvas.width = displayWidth * dpr;
                mainCanvas.height = displayHeight * dpr;

                configureDrawingContext(mainCtx, displayWidth, displayHeight, false);
                mainCtx.imageSmoothingEnabled = true;
                redrawMainCanvas();
            };
            appState.backgroundImage.src = docUrl;
        }

        function redrawMainCanvas(isExporting = false) {
            if (!mainCtx || !appState.backgroundImage) return;
            
            const logicalWidth = mainCanvas.width / dpr;
            const logicalHeight = mainCanvas.height / dpr;

            // Limpiar y dibujar fondo
            mainCtx.clearRect(0, 0, logicalWidth, logicalHeight);
            mainCtx.drawImage(appState.backgroundImage, 0, 0, logicalWidth, logicalHeight);

            const currentDocSettings = appState.documentSettings[appState.currentDocumentUrl];
            if (!currentDocSettings) return;

            // Dibujar elementos (Firma, nombre, etc)
            currentDocSettings.elements.forEach(element => {
                const imageToDraw = appState[element.id + 'ImageCache'];
                if (imageToDraw) {
                    mainCtx.drawImage(imageToDraw, element.x, element.y, element.width, element.height);
                    
                    // Dibujar borde de selección si está activo y no estamos exportando
                    if (appState.activeElementId === element.id && !isExporting) {
                        mainCtx.strokeStyle = '#0069d9';
                        mainCtx.lineWidth = 2;
                        mainCtx.strokeRect(element.x, element.y, element.width, element.height);

                        // Dibujar manejador de tamaño
                        const handleSize = RESIZE_HANDLE_LOGICAL_SIZE;
                        mainCtx.fillStyle = '#0069d9';
                        mainCtx.fillRect(
                            element.x + element.width - handleSize/2, 
                            element.y + element.height - handleSize/2, 
                            handleSize, handleSize
                        );
                    }
                }
            });
        }

        // --- INTERACCIÓN CON EL CANVAS FINAL (Drag & Drop) ---

        function getElementById(docUrl, elementId) {
            return appState.documentSettings[docUrl].elements.find(el => el.id === elementId);
        }

        function isPointInElement(x, y, el) {
            return x >= el.x && x <= el.x + el.width && y >= el.y && y <= el.y + el.height;
        }

        function isPointInResizeHandle(x, y, el) {
            const padding = RESIZE_HANDLE_CLICK_EXTENSION;
            const right = el.x + el.width;
            const bottom = el.y + el.height;
            return x >= right - padding && x <= right + padding + 10 &&
                   y >= bottom - padding && y <= bottom + padding + 10;
        }

        function getCanvasCoords(e) {
            const rect = mainCanvas.getBoundingClientRect();
            let cx, cy;
            if(e.touches && e.touches.length > 0) {
                cx = e.touches[0].clientX; cy = e.touches[0].clientY;
            } else {
                cx = e.clientX; cy = e.clientY;
            }
            // Convertir a coordenadas lógicas del canvas (teniendo en cuenta escala CSS vs Atributo)
            const scaleX = mainCanvas.width / dpr / rect.width;
            const scaleY = mainCanvas.height / dpr / rect.height;
            return {
                x: (cx - rect.left) * scaleX,
                y: (cy - rect.top) * scaleY
            };
        }

        function handleMainStart(e) {
            if(e.cancelable) e.preventDefault();
            const coords = getCanvasCoords(e);
            const settings = appState.documentSettings[appState.currentDocumentUrl];
            if(!settings) return;

            let clickedResize = false;
            let foundId = null;

            // Chequear si clicó en el resize handle del elemento activo
            if(appState.activeElementId) {
                const activeEl = getElementById(appState.currentDocumentUrl, appState.activeElementId);
                if(isPointInResizeHandle(coords.x, coords.y, activeEl)) {
                    clickedResize = true;
                    foundId = appState.activeElementId;
                }
            }

            // Si no fue resize, buscar si clicó en un elemento
            if(!clickedResize) {
                // Iterar al revés para seleccionar el de más arriba
                for(let i = settings.elements.length - 1; i >= 0; i--) {
                    if(isPointInElement(coords.x, coords.y, settings.elements[i])) {
                        foundId = settings.elements[i].id;
                        break;
                    }
                }
            }

            appState.activeElementId = foundId;

            if(foundId) {
                const el = getElementById(appState.currentDocumentUrl, foundId);
                if(clickedResize) {
                    appState.resizeState = {
                        isResizing: true,
                        elementId: foundId,
                        startX: coords.x,
                        initialElement: { ...el, aspectRatio: el.width / el.height }
                    };
                } else {
                    appState.dragState = {
                        isDragging: true,
                        elementId: foundId,
                        offsetX: coords.x - el.x,
                        offsetY: coords.y - el.y
                    };
                }
            }
            redrawMainCanvas();
        }

        function handleMainMove(e) {
            if(e.cancelable) e.preventDefault();
            const coords = getCanvasCoords(e);
            
            if(appState.resizeState.isResizing) {
                const el = getElementById(appState.currentDocumentUrl, appState.resizeState.elementId);
                const dx = coords.x - appState.resizeState.startX;
                const initial = appState.resizeState.initialElement;
                
                let newW = Math.max(MIN_ELEMENT_DIM, initial.width + dx);
                let newH = newW / initial.aspectRatio;

                el.width = newW;
                el.height = newH;
                redrawMainCanvas();
            } else if(appState.dragState.isDragging) {
                const el = getElementById(appState.currentDocumentUrl, appState.dragState.elementId);
                el.x = coords.x - appState.dragState.offsetX;
                el.y = coords.y - appState.dragState.offsetY;
                redrawMainCanvas();
            }
        }

        function handleMainEnd() {
            appState.resizeState.isResizing = false;
            appState.dragState.isDragging = false;
        }

        // --- EXPORTAR ---
        document.getElementById('exportDocumentBtn').addEventListener('click', () => {
            // Deseleccionar para que no salga el borde azul
            const savedId = appState.activeElementId;
            appState.activeElementId = null;
            redrawMainCanvas(true);

            const link = document.createElement('a');
            link.download = `Lulo_Firmado_${new Date().getTime()}.jpg`;
            link.href = mainCanvas.toDataURL('image/jpeg', 0.9);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Restaurar estado
            appState.activeElementId = savedId;
            redrawMainCanvas();
        });


        // --- INICIALIZACIÓN ---
        function init() {
            initDocumentGrid();
            initializeDefaultDocumentSettings();

            // Event Listeners botones pasos
            document.getElementById('confirmNameBtn').onclick = () => confirmStep(nameCtx, 'nameImageCache', nameCanvasEl);
            document.getElementById('clearNameBtn').onclick = () => clearPad(nameCtx, nameCanvasEl, 'name');

            document.getElementById('confirmCedulaBtn').onclick = () => confirmStep(cedulaCtx, 'cedulaImageCache', cedulaCanvasEl);
            document.getElementById('clearCedulaBtn').onclick = () => clearPad(cedulaCtx, cedulaCanvasEl, 'cedula');

            document.getElementById('confirmDateBtn').onclick = () => confirmStep(dateCtx, 'dateImageCache', dateCanvasEl);
            document.getElementById('clearDateBtn').onclick = () => clearPad(dateCtx, dateCanvasEl, 'date');

            document.getElementById('confirmSignatureBtn').onclick = () => confirmStep(sigCtx, 'signatureImageCache', signaturePadEl);
            document.getElementById('clearSignatureBtn').onclick = () => clearPad(sigCtx, signaturePadEl, 'signature');

            // Event Listeners Main Canvas (Touch & Mouse)
            const opts = { passive: false };
            mainCanvas.addEventListener('mousedown', handleMainStart);
            mainCanvas.addEventListener('mousemove', handleMainMove);
            mainCanvas.addEventListener('mouseup', handleMainEnd);
            mainCanvas.addEventListener('touchstart', handleMainStart, opts);
            mainCanvas.addEventListener('touchmove', handleMainMove, opts);
            mainCanvas.addEventListener('touchend', handleMainEnd);
        }

        // Arrancar
        window.onload = init;

    </script>
</body>
</html>
